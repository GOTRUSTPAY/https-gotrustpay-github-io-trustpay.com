<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GOPAY AFRICA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{
margin:0;
font-family:Roboto;
background:#061e1c;
color:white;
}

/* HEADER */
header{
background:#012b28;
padding:12px 20px;
display:flex;
justify-content:space-between;
align-items:center;
}

.logo{
font-size:22px;
font-weight:bold;
color:#5eead4;
}

.menu{
cursor:pointer;
font-size:26px;
}

/* PANELS */
.panel{
background:#043837;
margin:20px;
padding:20px;
border-radius:18px;
}

.hidden{display:none;}

/* ACTION BUTTONS */
.actions{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
gap:10px;
margin-top:20px;
}

.action{
background:#14b8a6;
padding:12px;
border-radius:12px;
text-align:center;
font-weight:bold;
cursor:pointer;
}

/* CARD PREMIUM */
.card{
background:linear-gradient(135deg,#1d4ed8,#0ea5e9);
border-radius:20px;
padding:20px;
box-shadow:0 8px 25px rgba(0,0,0,0.5);
}

.card h3{margin:0;}
.card small{opacity:.8;}

#history p{
font-size:14px;
border-bottom:1px solid rgba(255,255,255,0.1);
padding:6px 0;
}

</style>
</head>

<body>

<header>
<div class="logo">GOPAY AFRICA</div>
<div class="menu" onclick="show('login')">☰</div>
</header>

<!-- HOME -->
<div id="home" class="panel">
<h2>Banque Digitale Africaine</h2>
<p>Paiements • Wallet • Agents • KYC sécurisé</p>
</div>

<!-- LOGIN -->
<div id="login" class="panel hidden">
<h3>Connexion</h3>

<input id="lEmail" placeholder="Email"><br><br>
<input id="lPass" type="password" placeholder="Mot de passe"><br><br>

<div class="actions">
<div class="action" onclick="login()">Connexion</div>
<div class="action" onclick="show('register')">Créer compte</div>
</div>
</div>

<!-- REGISTER -->
<div id="register" class="panel hidden">

<h3>Créer Compte</h3>

<input id="rName" placeholder="Nom"><br><br>
<input id="rEmail" placeholder="Email"><br><br>
<input id="rPass" type="password" placeholder="Mot de passe"><br><br>

<select id="rRole">
<option value="client">Client</option>
<option value="agent">Agent</option>
<option value="admin">Admin</option>
</select>

<div class="actions">
<div class="action" onclick="register()">Créer</div>
</div>

</div>

<!-- DASHBOARD -->
<div id="dash" class="panel hidden">

<div class="card">
<h3 id="cardName"></h3>
<small>ID : <span id="cardId"></span></small>

<h2>$ <span id="balance"></span></h2>

<canvas id="qr"></canvas>
</div>

<div class="actions">
<div class="action" onclick="cashin()">Cash-in</div>
<div class="action" onclick="cashout()">Cash-out</div>
<div class="action" onclick="pay()">Paiement</div>
<div class="action" onclick="openKYC()">KYC</div>
<div class="action" onclick="logout()">Déconnexion</div>
</div>

<h4>Activités Récentes</h4>
<div id="history"></div>

</div>

<!-- ADMIN -->
<div id="admin" class="panel hidden">
<h3>Admin Dashboard</h3>
<p>Total Users : <span id="totalUsers"></span></p>

<table id="usersTable"></table>

<div class="action" onclick="show('dash')">Retour</div>
</div>

<script>

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
authDomain:"gotrustpay-e6524.firebaseapp.com",
projectId:"gotrustpay-e6524",
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;

/* NAVIGATION */
function show(id){
document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

/* REGISTER */
async function register(){

const cred=await auth.createUserWithEmailAndPassword(
rEmail.value,
rPass.value
);

const gid="GP"+Math.random().toString(36).substring(2,7).toUpperCase();

await db.collection("users").doc(cred.user.uid).set({
name:rName.value,
email:rEmail.value,
role:rRole.value,
gid,
balance:50,
session:null
});

loginAuto();
}

/* LOGIN */
async function login(){

const cred=await auth.signInWithEmailAndPassword(
lEmail.value,
lPass.value
);

loadUserData(cred.user.uid);

}

/* AUTO LOGIN */
async function loginAuto(){
loadUserData(auth.currentUser.uid);
}

/* SESSION */
async function loadUserData(uid){

const snap=await db.collection("users").doc(uid).get();
currentUser=snap.data();

if(currentUser.session && currentUser.session!==uid){
alert("Session active ailleurs");
logout();
return;
}

await db.collection("users").doc(uid).update({session:uid});

loadDashboard();

}

/* DASHBOARD */
function loadDashboard(){

cardName.innerText=currentUser.name;
cardId.innerText=currentUser.gid;
balance.innerText=currentUser.balance.toFixed(2);

QRCode.toCanvas(qr,currentUser.gid);

loadFakeHistory();

if(currentUser.role==="admin"){
setTimeout(()=>openAdmin(),500);
}

show("dash");

}

/* CASH IN */
async function cashin(){
let amt=parseFloat(prompt("Montant"));
if(!amt)return;

await db.collection("users")
.doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(amt)});

currentUser.balance+=amt;
loadDashboard();
}

/* CASH OUT */
async function cashout(){
let amt=parseFloat(prompt("Montant"));
if(!amt)return;

await db.collection("users")
.doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(-amt)});

currentUser.balance-=amt;
saveTransaction("cashout",amt);
loadDashboard();
}

/* PAYMENT */
async function pay(){

let amt=parseFloat(prompt("Montant"));
let dest=prompt("ID destinataire");

let snap=await db.collection("users")
.where("gid","==",dest)
.get();

if(snap.empty){
alert("Utilisateur introuvable");
return;
}

let doc=snap.docs[0];

await db.collection("users")
.doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(-amt)});

await db.collection("users")
.doc(doc.id)
.update({balance:firebase.firestore.FieldValue.increment(amt)});

saveTransaction("payment",amt);

currentUser.balance-=amt;
loadDashboard();

}

/* TRANSACTION */
function saveTransaction(type,amount){
db.collection("transactions").add({
user:currentUser.gid,
type,
amount,
date:new Date()
});
}

/* HISTORIQUE FAKE STYLE BINANCE */
function loadFakeHistory(){

const names=["Ali","John","Fatou","David","Eric","Nadine","Prince"];

history.innerHTML="";

for(let i=0;i<6;i++){

let n=names[Math.floor(Math.random()*names.length)];
let amt=(Math.random()*200).toFixed(2);

history.innerHTML+=`<p>${n} a transféré $${amt}</p>`;
}

}

/* KYC */
function openKYC(){
alert("KYC soumis - Vérification en cours");
}

/* ADMIN */
async function openAdmin(){

show("admin");

let users=await db.collection("users").get();

totalUsers.innerText=users.size;

usersTable.innerHTML="<tr><th>Nom</th><th>Email</th><th>Role</th></tr>";

users.forEach(doc=>{
let u=doc.data();
usersTable.innerHTML+=`
<tr>
<td>${u.name}</td>
<td>${u.email}</td>
<td>${u.role}</td>
</tr>
`;
});

}

/* LOGOUT */
function logout(){
auth.signOut();
show("home");
}

</script>
</body>
</html>
