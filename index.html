<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoTrust Pay</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg:#021c1b;
  --panel:#043837;
  --card:#065f5b;
  --accent:#14b8a6;
  --text:#d1fae5;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#021c1b,#032f2e);
  color:var(--text);
}
header{
  background:#021c1b;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
}
nav a{
  color:#99f6e4;
  margin-left:20px;
  font-weight:bold;
  cursor:pointer;
  text-decoration:none;
}
main{max-width:1200px;margin:25px auto;padding:20px}
.hidden{display:none}
button{
  background:var(--accent);
  border:none;
  padding:10px 16px;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
input,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
}
.panel{
  background:var(--panel);
  border-radius:14px;
  padding:20px;
  margin-top:20px;
}
.card{
  background:linear-gradient(135deg,#054a48,#022c2a);
  border-radius:18px;
  padding:25px;
  display:flex;
  justify-content:space-between;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.chip{
  width:50px;height:38px;
  background:linear-gradient(135deg,#facc15,#eab308);
  border-radius:6px;
  margin-bottom:10px;
}
.activity{
  background:#022c2a;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  font-size:14px;
}
.small{font-size:13px;opacity:.8}
</style>
</head>

<body>

<header>
  <nav>
    <a onclick="show('home')">Accueil</a>
    <a onclick="show('login')">Connexion</a>
    <a id="adminBtn" class="hidden" onclick="show('admin')">Admin</a>
  </nav>
</header>

<main>

<!-- HOME -->
<div id="home">
  <div class="panel">
    <h2>Activités récentes</h2>
    <div id="activities"></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden panel">
  <h2>Connexion</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button onclick="login()">Connexion</button>

  <h3>Créer un compte</h3>
  <input id="name" placeholder="Nom complet">
  <input id="phone" placeholder="Téléphone">
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password" placeholder="Mot de passe">
  <button onclick="register()">Créer</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <div class="card">
    <div>
      <div class="chip"></div>
      <h3 id="cardName"></h3>
      <p>ID : <span id="cardId"></span></p>
      <p>Carte : <span id="cardNumber"></span></p>
      <p><b>Solde : <span id="balance"></span> USD</b></p>
    </div>
    <div>
      <div id="clientQR" style="background:#fff;padding:6px;border-radius:8px"></div>
      <button onclick="downloadQR()">Télécharger QR</button>
    </div>
  </div>

  <!-- DEPOT -->
  <div class="panel">
    <h3>Dépôt Mobile Money</h3>
    <select id="mmType">
      <option>Airtel Money</option>
      <option>Orange Money</option>
      <option>Vodacom M-Pesa</option>
      <option>GoPay</option>
    </select>
    <input id="mmPhone" placeholder="Numéro Mobile Money">
    <input id="mmAmount" type="number" placeholder="Montant">
    <button onclick="mobileDeposit()">Confirmer dépôt</button>
    <p class="small">Anti-double paiement activé</p>
  </div>

  <!-- HISTORIQUE -->
  <div class="panel">
    <h3>Historique des dépôts</h3>
    <div id="history"></div>
  </div>

</div>

<!-- ADMIN -->
<div id="admin" class="hidden panel">
  <h2>Mode Admin</h2>
  <div id="adminDeposits"></div>
</div>

</main>

<script>
// FIREBASE
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth=firebase.auth(), db=firebase.firestore();

let lastDepositTime=0;

// NAV
function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// REGISTER
function genCard(){return "4896 "+Math.floor(1000+Math.random()*9000)+" **** ****";}
function register(){
 auth.createUserWithEmailAndPassword(regEmail.value,regPass.value)
 .then(c=>db.collection("users").doc(c.user.uid).set({
  name:name.value,
  phone:phone.value,
  card:genCard(),
  balance:0,
  role:"client"
 }));
}

// LOGIN
function login(){
 auth.signInWithEmailAndPassword(email.value,password.value);
}

// AUTH
auth.onAuthStateChanged(u=>{
 if(!u){show("home");return;}
 db.collection("users").doc(u.uid).get().then(d=>{
  const x=d.data();
  show("dashboard");
  cardName.textContent=x.name;
  cardId.textContent=u.uid.slice(0,10).toUpperCase();
  cardNumber.textContent=x.card;
  balance.textContent=x.balance.toFixed(2);
  if(x.role==="admin") adminBtn.classList.remove("hidden");
  clientQR.innerHTML="";
  new QRCode("clientQR",{text:u.uid,width:130,height:130});
  loadHistory();
  loadAdmin();
 });
 loadActivities();
});

// DEPOT + FRAUDE
function mobileDeposit(){
 const now=Date.now();
 if(now-lastDepositTime<10000){
  alert("Double paiement bloqué");
  return;
 }
 lastDepositTime=now;

 const amount=Number(mmAmount.value);
 const uid=auth.currentUser.uid;

 db.collection("users").doc(uid)
 .update({balance:firebase.firestore.FieldValue.increment(amount)});

 db.collection("deposits").add({
  uid,
  amount,
  method:mmType.value,
  phone:mmPhone.value,
  date:new Date()
 });

 alert("Dépôt en traitement");
 loadHistory();
}

// HISTORIQUE
function loadHistory(){
 history.innerHTML="";
 db.collection("deposits")
 .where("uid","==",auth.currentUser.uid)
 .orderBy("date","desc")
 .get().then(s=>{
  s.forEach(d=>{
   const x=d.data();
   history.innerHTML+=`<div class="activity">${x.method} ${x.amount} USD <span>${x.date.toDate().toLocaleString()}</span></div>`;
  });
 });
}

// ADMIN
function loadAdmin(){
 adminDeposits.innerHTML="";
 db.collection("deposits").orderBy("date","desc").limit(20).get()
 .then(s=>{
  s.forEach(d=>{
   const x=d.data();
   adminDeposits.innerHTML+=`<div class="activity">${x.method} ${x.amount} USD <span>${x.phone}</span></div>`;
  });
 });
}

// ACTIVITÉS PUBLIQUES
function randName(){
 const f=["Amina","Patrick","Sofia","Daniel","Jean","Ali","Emma","Paul","Koffi","Lina"];
 const l=["R.","K.","M.","L.","S.","D.","B.","T."];
 return f[Math.floor(Math.random()*f.length)]+" "+l[Math.floor(Math.random()*l.length)];
}
function randNum(){return Math.floor(100000+Math.random()*900000);}
function loadActivities(){
 activities.innerHTML="";
 for(let i=0;i<12;i++){
  activities.innerHTML+=`<div class="activity">${randName()} transaction <span>${randNum()}</span></div>`;
 }
 setTimeout(loadActivities,2500);
}

// QR
function downloadQR(){
 const canvas=document.querySelector("#clientQR canvas");
 const a=document.createElement("a");
 a.href=canvas.toDataURL();
 a.download="gotrustpay-qr.png";
 a.click();
}
</script>

</body>
</html>
