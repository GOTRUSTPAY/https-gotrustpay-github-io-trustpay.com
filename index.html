<script>
// ================= FIREBASE =================
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth = firebase.auth();
const db = firebase.firestore();

let lastDeposit = 0;

// ================= NAV =================
function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// ================= REGISTER =================
function genCard(){
 return "4896 "+Math.floor(1000+Math.random()*9000)+" **** ****";
}

async function register(){
 if(!regEmail.value || !regPass.value || !name.value) return alert("Champs requis");

 const cred = await auth.createUserWithEmailAndPassword(regEmail.value, regPass.value);

 await db.collection("users").doc(cred.user.uid).set({
   name: name.value,
   phone: phone.value,
   card: genCard(),
   balance: 0,
   role: "client",
   kyc: "none",
   createdAt: firebase.firestore.FieldValue.serverTimestamp()
 });

 // reset champs
 name.value = phone.value = regEmail.value = regPass.value = "";

 // accès immédiat dashboard
 show("dashboard");
}

// ================= LOGIN =================
async function login(){
 await auth.signInWithEmailAndPassword(email.value, password.value);
 email.value = password.value = "";
}

// ================= AUTH STATE =================
auth.onAuthStateChanged(user=>{
 if(!user){
   show("home");
   adminBtn.classList.add("hidden");
   return;
 }

 // accès client direct
 show("dashboard");

 db.collection("users").doc(user.uid).onSnapshot(doc=>{
   if(!doc.exists) return;
   const x = doc.data();

   cardName.textContent = x.name;
   cardId.textContent = user.uid.slice(0,10).toUpperCase();
   cardNumber.textContent = x.card;
   balance.textContent = x.balance.toFixed(2);
   kycStatus.textContent = "KYC : " + x.kyc;

   if(x.role === "admin") adminBtn.classList.remove("hidden");

   clientQR.innerHTML = "";
   new QRCode("clientQR",{ text:user.uid, width:130, height:130 });
 });

 loadHistory(user.uid);
 loadAdmin();
 loadActivities();
});

// ================= DEPOT =================
async function mobileDeposit(){
 if(Date.now()-lastDeposit < 10000) return alert("Double paiement bloqué");
 lastDeposit = Date.now();

 const uid = auth.currentUser.uid;
 const amount = Number(mmAmount.value);
 if(amount<=0) return alert("Montant invalide");

 await db.collection("deposits").add({
   uid, amount,
   phone: mmPhone.value,
   method: mmType.value,
   status: "pending",
   date: firebase.firestore.FieldValue.serverTimestamp()
 });

 mmAmount.value = mmPhone.value = "";
 alert("Dépôt envoyé, attente validation admin");
}

// ================= HISTORIQUE =================
function loadHistory(uid){
 db.collection("deposits")
 .where("uid","==",uid)
 .orderBy("date","desc")
 .onSnapshot(s=>{
   history.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     history.innerHTML+=`
     <div class="activity">
      ${x.method} ${x.amount} USD
      <span class="badge ${x.status==="approved"?"ok":x.status==="rejected"?"no":"wait"}">
        ${x.status}
      </span>
     </div>`;
   });
 });
}

// ================= ADMIN =================
function loadAdmin(){
 db.collection("deposits").where("status","==","pending")
 .onSnapshot(s=>{
   adminDeposits.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     adminDeposits.innerHTML+=`
     <div class="activity">
       ${x.method} ${x.amount} USD
       <span>
         <button onclick="approve('${d.id}','${x.uid}',${x.amount})">✔</button>
         <button onclick="reject('${d.id}')">✖</button>
       </span>
     </div>`;
   });
 });
}

function approve(id,uid,amt){
 db.collection("deposits").doc(id).update({status:"approved"});
 db.collection("users").doc(uid)
 .update({balance:firebase.firestore.FieldValue.increment(amt)});
}
function reject(id){
 db.collection("deposits").doc(id).update({status:"rejected"});
}

// ================= KYC =================
function submitKYC(){
 db.collection("users").doc(auth.currentUser.uid).update({kyc:"submitted"});
 alert("KYC envoyé");
}

// ================= ACTIVITES =================
function loadActivities(){
 activities.innerHTML="";
 const names=["Amina","Patrick","Sofia","Daniel","Ali","Emma","Jean"];
 for(let i=0;i<10;i++){
  activities.innerHTML+=`
  <div class="activity">
    ${names[Math.floor(Math.random()*names.length)]} transaction
    <span>${Math.floor(Math.random()*900000+100000)}</span>
  </div>`;
 }
 setTimeout(loadActivities,3000);
}

// ================= QR =================
function downloadQR(){
 const c=document.querySelector("#clientQR canvas");
 const a=document.createElement("a");
 a.href=c.toDataURL();
 a.download="qr.png";
 a.click();
}
   </script>
