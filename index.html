<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoPay Africa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:Roboto;
background:#061e1c;
color:#e6fffa;
}

/* HEADER */
header{
background:#012b28;
padding:12px 20px;
display:flex;
justify-content:space-between;
align-items:center;
}

.logo-text{
font-size:24px;
font-weight:700;
color:#5eead4;
}

.menu-btn{
font-size:28px;
cursor:pointer;
}

.menu{
display:none;
position:absolute;
top:60px;
right:20px;
background:#043837;
border-radius:12px;
overflow:hidden;
z-index:100;
}

.menu a{
display:block;
padding:12px;
color:#5eead4;
text-decoration:none;
cursor:pointer;
}

.menu a:hover{
background:#065f5b;
}

main{
max-width:1000px;
margin:auto;
padding:20px;
}

.panel{
background:#043837;
padding:20px;
border-radius:18px;
margin-top:20px;
}

.hidden{
display:none;
}

/* CARD */
.card{
background:linear-gradient(135deg,#0b3c39,#021f1d);
border-radius:22px;
padding:22px;
box-shadow:0 20px 40px rgba(0,0,0,.6);
cursor:pointer;
transition:.6s;
transform-style:preserve-3d;
position:relative;
height:220px;
}

.card-inner{
position:relative;
width:100%;
height:100%;
transition:0.6s;
transform-style:preserve-3d;
}

.card.flip .card-inner{
transform:rotateY(180deg);
}

.card-front,.card-back{
position:absolute;
width:100%;
height:100%;
backface-visibility:hidden;
border-radius:22px;
}

.card-back{
transform:rotateY(180deg);
display:flex;
justify-content:center;
align-items:center;
}

.card-avatar{
width:50px;
height:50px;
border-radius:50%;
margin-right:10px;
}

/* ACTIONS */
.actions{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:15px;
margin-top:20px;
}

.action{
background:#14b8a6;
padding:15px;
border-radius:14px;
text-align:center;
font-weight:700;
cursor:pointer;
}

.action:hover{
background:#2dd4bf;
}

/* INPUTS */
input,select,button{
width:100%;
padding:10px;
margin-top:10px;
border-radius:10px;
border:none;
}

button{
background:#14b8a6;
font-weight:700;
cursor:pointer;
}

/* TX */
.tx{
background:#065f5b;
padding:10px;
border-radius:10px;
margin-bottom:8px;
}

/* ADMIN */
table{
width:100%;
border-collapse:collapse;
}

td,th{
padding:8px;
border-bottom:1px solid #065f5b;
}

</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>

<body>

<header>
<div class="logo-text">GoPay Africa</div>
<div class="menu-btn" onclick="toggleMenu()">☰</div>
</header>

<div class="menu" id="menu">
<a onclick="show('home')">Accueil</a>
<a onclick="show('login')">Connexion</a>
<a onclick="logout()">Déconnexion</a>
<a id="adminLink" onclick="show('admin')">Admin</a>
</div>

<main>

<!-- HOME -->
<div id="home" class="panel">
<h2>Paiements Digitaux Africains</h2>
<div id="homeQR"></div>
</div>

<!-- LOGIN -->
<div id="login" class="panel hidden">
<h3>Connexion</h3>
<input id="lEmail" placeholder="Email">
<input id="lPass" type="password" placeholder="Mot de passe">
<button onclick="login()">Connexion</button>
</div>

<!-- DASH -->
<div id="dash" class="hidden">

<div class="card" id="card">
<div class="card-inner">

<div class="card-front">
<h3>Virtual Card</h3>

<div style="display:flex;align-items:center">
<img id="cardAvatar" class="card-avatar">
<div>
<div id="cardName"></div>
<div id="cardId"></div>
</div>
</div>

<p>Solde : <b id="balance">0</b> USD</p>

</div>

<div class="card-back">
<div id="cardQR"></div>
</div>

</div>
</div>

<div class="actions">
<div class="action" onclick="openP('pay')">Paiement</div>
<div class="action" onclick="openP('cashin')">Cash-in</div>
<div class="action" onclick="openP('cashout')">Cash-out</div>
</div>

<div id="pay" class="panel hidden">
<input id="payId" placeholder="ID destinataire">
<input id="payAmount" type="number" placeholder="Montant">
<button onclick="pay()">Envoyer</button>
</div>

<div id="cashin" class="panel hidden">
<input id="cinAmount" type="number" placeholder="Montant">
<button onclick="cashin()">Valider</button>
</div>

<div id="cashout" class="panel hidden">
<input id="coutId" placeholder="ID destinataire">
<input id="coutAmount" type="number" placeholder="Montant">
<button onclick="cashout()">Envoyer</button>
</div>

<div class="panel">
<h3>Historique</h3>
<div id="myTx"></div>
</div>

</div>

<!-- ADMIN -->
<div id="admin" class="panel hidden">
<h3>Admin Panel</h3>
<table id="usersTable"></table>
</div>

</main>

<script>

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
authDomain:"gotrustpay-e6524.firebaseapp.com",
projectId:"gotrustpay-e6524",
storageBucket:"gotrustpay-e6524.appspot.com"
});

const auth=firebase.auth();
const db=firebase.firestore();

/* RESET USERS */
async function resetUsers(){
const flag=localStorage.getItem("resetDone");
if(flag) return;

const users=await db.collection("users").get();
users.forEach(d=>{
if(d.data().email!=="motivixx.media@gmail.com"){
db.collection("users").doc(d.id).delete();
}
});
localStorage.setItem("resetDone",true);
}
resetUsers();

/* NAV */
function toggleMenu(){
menu.style.display=menu.style.display==="block"?"none":"block";
}

function show(id){
document.querySelectorAll(".panel,#dash").forEach(x=>x.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

/* LOGIN */
async function login(){
try{
const cred=await auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
const doc=await db.collection("users").doc(cred.user.uid).get();
const u=doc.data();

cardName.textContent=u.name;
cardId.textContent=u.gid;
balance.textContent=u.balance;
cardAvatar.src=u.photo;

QRCode.toCanvas(cardQR,u.gid);

if(u.role==="admin"){
adminLink.style.display="block";
loadAdmin();
show("admin");
}else{
show("dash");
}

}catch(e){
alert(e.message);
}
}

/* REGISTER SIMPLE AUTO */
auth.onAuthStateChanged(async user=>{
if(!user) return;

const doc=await db.collection("users").doc(user.uid).get();
if(doc.exists) return;

await db.collection("users").doc(user.uid).set({
name:user.email.split("@")[0],
email:user.email,
gid:"GP-"+Math.random().toString(36).substr(2,7).toUpperCase(),
balance:100,
role:"client",
kyc:"verified",
photo:"https://i.pravatar.cc/150"
});
});

/* TX */
async function pay(){
const amt=parseFloat(payAmount.value);
const me=await db.collection("users").doc(auth.currentUser.uid).get();
if(me.data().balance<amt) return alert("Solde insuffisant");

const dest=await db.collection("users").where("gid","==",payId.value).get();
if(dest.empty) return alert("ID invalide");

await db.collection("users").doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(-amt)});

await db.collection("users").doc(dest.docs[0].id)
.update({balance:firebase.firestore.FieldValue.increment(amt)});

await db.collection("tx").add({
from:me.data().gid,
to:payId.value,
amount:amt,
date:new Date()
});

loadTx();
}

/* CASHIN */
async function cashin(){
const amt=parseFloat(cinAmount.value);

await db.collection("users").doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(amt)});

loadTx();
}

/* CASHOUT */
async function cashout(){
const amt=parseFloat(coutAmount.value);
await pay();
}

/* LOAD TX */
async function loadTx(){
myTx.innerHTML="";
const me=cardId.textContent;

const snap=await db.collection("tx")
.where("from","==",me)
.orderBy("date","desc")
.limit(5).get();

snap.forEach(d=>{
myTx.innerHTML+=`<div class="tx">${d.data().amount} USD</div>`;
});
}

/* ADMIN */
async function loadAdmin(){
usersTable.innerHTML="<tr><th>Nom</th><th>Email</th><th>Solde</th></tr>";
const users=await db.collection("users").get();

users.forEach(d=>{
const u=d.data();
usersTable.innerHTML+=`
<tr>
<td>${u.name}</td>
<td>${u.email}</td>
<td>${u.balance}</td>
</tr>`;
});
}

/* CARD */
card.onclick=()=>card.classList.toggle("flip");

/* ACTION PANEL */
function openP(id){
["pay","cashin","cashout"].forEach(x=>document.getElementById(x).classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

/* LOGOUT */
function logout(){
auth.signOut();
show("home");
}

QRCode.toCanvas(homeQR,"GoPay Africa");

</script>

</body>
</html>
