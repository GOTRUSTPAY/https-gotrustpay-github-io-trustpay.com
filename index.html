<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoTrust Pay</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg:#021c1b;
  --panel:#043837;
  --card:#065f5b;
  --accent:#14b8a6;
  --text:#d1fae5;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#021c1b,#032f2e);
  color:var(--text);
}
header{
  background:#021c1b;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
}
nav a{
  color:#99f6e4;
  margin-left:20px;
  font-weight:bold;
  cursor:pointer;
  text-decoration:none;
}
main{
  max-width:1200px;
  margin:25px auto;
  padding:20px;
  display:none; /* üîê BLOQU√â par d√©faut */
}
.hidden{display:none}
button{
  background:var(--accent);
  border:none;
  padding:10px 16px;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
input,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
}
.panel{
  background:var(--panel);
  border-radius:14px;
  padding:20px;
  margin-top:20px;
}
.card{
  background:linear-gradient(135deg,#054a48,#022c2a);
  border-radius:18px;
  padding:25px;
  display:flex;
  justify-content:space-between;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.chip{
  width:50px;height:38px;
  background:linear-gradient(135deg,#facc15,#eab308);
  border-radius:6px;
  margin-bottom:10px;
}
.activity{
  background:#022c2a;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  font-size:14px;
}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.ok{background:#14532d}
.wait{background:#7c2d12}
.no{background:#7f1d1d}
</style>
</head>

<body>

<header>
  <nav>
    <a onclick="show('home')">Accueil</a>
    <a onclick="show('login')">Connexion</a>
    <a id="adminBtn" class="hidden" onclick="show('admin')">Admin</a>
  </nav>
</header>

<main>

<!-- HOME -->
<div id="home">
  <div class="panel">
    <h2>Activit√©s r√©centes</h2>
    <div id="activities"></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden panel">
  <h2>Connexion</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password">
  <button onclick="login()">Connexion</button>

  <h3>Cr√©er un compte</h3>
  <input id="name" placeholder="Nom complet">
  <input id="phone" placeholder="T√©l√©phone">
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password">
  <button onclick="register()">Cr√©er</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <div class="card">
    <div>
      <div class="chip"></div>
      <h3 id="cardName"></h3>
      <p>ID : <span id="cardId"></span></p>
      <p>Carte : <span id="cardNumber"></span></p>
      <p><b>Solde : <span id="balance"></span> USD</b></p>
    </div>
    <div>
      <div id="clientQR" style="background:#fff;padding:6px;border-radius:8px"></div>
    </div>
  </div>

  <div class="panel">
    <h3>D√©p√¥t Mobile Money (test)</h3>
    <select id="mmType">
      <option>Airtel Money</option>
      <option>Orange Money</option>
      <option>Vodacom M-Pesa</option>
      <option>GoPay</option>
    </select>
    <input id="mmPhone" placeholder="Num√©ro">
    <input id="mmAmount" type="number" placeholder="Montant">
    <button onclick="deposit()">D√©poser</button>
  </div>

  <div class="panel">
    <h3>Historique d√©p√¥ts</h3>
    <div id="history"></div>
  </div>

</div>

<!-- ADMIN -->
<div id="admin" class="hidden panel">
  <h2>Admin ‚Äì Validation d√©p√¥ts</h2>
  <div id="adminDeposits"></div>
</div>

</main>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
  authDomain:"gotrustpay-e6524.firebaseapp.com",
  projectId:"gotrustpay-e6524"
});
const auth=firebase.auth();
const db=firebase.firestore();
let lastDeposit=0;

// NAV
function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// REGISTER (CLIENT ONLY)
function genCard(){
 return "4896 "+Math.floor(1000+Math.random()*9000)+" **** ****";
}
function register(){
 auth.createUserWithEmailAndPassword(regEmail.value,regPass.value)
 .then(c=>db.collection("users").doc(c.user.uid).set({
   name:name.value,
   phone:phone.value,
   card:genCard(),
   balance:0,
   role:"client"
 }));
}

// LOGIN
function login(){
 auth.signInWithEmailAndPassword(email.value,password.value);
}

// AUTH BLIND√â
auth.onAuthStateChanged(u=>{
 if(!u){
   show("home");
   document.querySelector("main").style.display="block";
   return;
 }

 db.collection("users").doc(u.uid).get().then(d=>{
   if(!d.exists){auth.signOut();return;}

   const x=d.data();
   show("dashboard");
   cardName.textContent=x.name;
   cardId.textContent=u.uid.slice(0,10).toUpperCase();
   cardNumber.textContent=x.card;
   balance.textContent=x.balance.toFixed(2);

   if(x.role==="admin"){
     adminBtn.classList.remove("hidden");
     loadAdmin();
   }

   clientQR.innerHTML="";
   new QRCode("clientQR",{text:u.uid,width:130,height:130});

   loadHistory();
   document.querySelector("main").style.display="block";
 });
});

// DEPOT (SANDBOX)
function deposit(){
 if(Date.now()-lastDeposit<10000){alert("Double paiement bloqu√©");return;}
 lastDeposit=Date.now();

 db.collection("deposits").add({
   uid:auth.currentUser.uid,
   amount:Number(mmAmount.value),
   method:mmType.value,
   phone:mmPhone.value,
   status:"pending",
   date:new Date()
 });
 alert("D√©p√¥t enregistr√© (test)");
}

// HISTORY
function loadHistory(){
 db.collection("deposits")
 .where("uid","==",auth.currentUser.uid)
 .orderBy("date","desc")
 .onSnapshot(s=>{
   history.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     history.innerHTML+=`
       <div class="activity">
         ${x.method} ${x.amount} USD
         <span class="badge ${x.status==="approved"?"ok":x.status==="rejected"?"no":"wait"}">${x.status}</span>
       </div>`;
   });
 });
}

// ADMIN
function loadAdmin(){
 db.collection("deposits").where("status","==","pending")
 .onSnapshot(s=>{
   adminDeposits.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     adminDeposits.innerHTML+=`
       <div class="activity">
         ${x.method} ${x.amount} USD
         <span>
           <button onclick="approve('${d.id}','${x.uid}',${x.amount})">‚úî</button>
           <button onclick="reject('${d.id}')">‚úñ</button>
         </span>
       </div>`;
   });
 });
}
function approve(id,uid,amt){
 db.collection("deposits").doc(id).update({status:"approved"});
 db.collection("users").doc(uid)
 .update({balance:firebase.firestore.FieldValue.increment(amt)});
}
function reject(id){
 db.collection("deposits").doc(id).update({status:"rejected"});
}

// ACTIVITES FAKE
function randName(){
 const a=["Amina","Jean","Paul","Sofia","Daniel","Ali","Emma"];
 return a[Math.floor(Math.random()*a.length)];
}
function loadActivities(){
 activities.innerHTML="";
 for(let i=0;i<10;i++){
   activities.innerHTML+=`<div class="activity">${randName()} transaction <span>${Math.floor(Math.random()*900000)}</span></div>`;
 }
 setTimeout(loadActivities,2500);
}
loadActivities();
</script>
</body>
</html>
