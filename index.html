<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoPay Africa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:Roboto;background:#061e1c;color:#e6fffa}
header{background:#012b28;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.logo-wrap{display:flex;align-items:center;gap:10px}
.logo-text{font-size:24px;font-weight:700;color:#5eead4}
.menu-btn{font-size:28px;cursor:pointer}
.menu{display:none;position:absolute;top:60px;right:20px;background:#043837;border-radius:12px;overflow:hidden;z-index:100}
.menu a{display:block;padding:12px 18px;color:#5eead4;text-decoration:none;cursor:pointer}
.menu a:hover{background:#065f5b}

main{max-width:1000px;margin:auto;padding:20px}
.panel{background:#043837;padding:20px;border-radius:18px;margin-top:20px}
.hidden{display:none}

/* Card pro bancaire 3D */
.card{background:linear-gradient(135deg,#0b3c39,#021f1d);border-radius:20px;padding:22px;box-shadow:0 20px 40px rgba(0,0,0,.6);cursor:pointer;transition:.6s;transform-style:preserve-3d;position:relative;}
.card h2{margin:0;font-size:16px;font-weight:500;opacity:.9}
.card-number{font-size:20px;letter-spacing:3px;margin:18px 0}
.card-row{display:flex;justify-content:space-between;font-size:13px;opacity:.9}

.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}
.action{background:#14b8a6;padding:15px;border-radius:14px;text-align:center;font-weight:700;cursor:pointer}
.action:hover{background:#2dd4bf}

input,select,button{width:100%;padding:10px;margin-top:10px;border-radius:10px;border:none;font-family:Roboto}
button{background:#14b8a6;font-weight:700;cursor:pointer}
button:hover{background:#2dd4bf}

.tx{background:#065f5b;padding:10px;border-radius:10px;margin-bottom:8px;font-size:14px}

footer{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;text-align:center;margin-top:30px;font-size:14px;opacity:.8}
footer a{color:#5eead4;text-decoration:none;cursor:pointer}
footer a:hover{text-decoration:underline}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;text-align:left;border-bottom:1px solid #065f5b}
button.admin-btn{padding:5px 8px;margin-left:5px;font-size:12px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>

<header>
<div class="logo-wrap">
<div class="logo-text">GoPay Africa</div>
</div>
<div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
</header>

<div class="menu" id="menu">
<a onclick="show('home')">Accueil</a>
<a onclick="show('login')">Connexion</a>
<a onclick="show('register')">Cr√©er un compte</a>
<a id="adminLink" onclick="show('admin')">Admin KYC</a>
<a id="agentLink" onclick="show('agentPanel')">Agent Panel</a>
<a onclick="logout()">D√©connexion</a>
</div>

<main>
<!-- HOME -->
<div id="home" class="panel">
<h2>Payments for a Connected Africa</h2>
<p>Paiements digitaux s√©curis√©s et fiables.</p>
<div id="home-qrcode"></div>
</div>

<!-- LOGIN -->
<div id="login" class="panel hidden">
<h3>Connexion</h3>
<input id="lEmail" placeholder="Email">
<input id="lPass" type="password" placeholder="Mot de passe">
<button onclick="login()">Se connecter</button>
</div>

<!-- REGISTER -->
<div id="register" class="panel hidden">
<h3>Inscription</h3>
<input id="rName" placeholder="Nom complet">
<input id="rEmail" placeholder="Email">
<input id="rPass" type="password" placeholder="Mot de passe">
<select id="rRole">
<option value="client">Client</option>
<option value="agent">Agent</option>
</select>
<button onclick="register()">Cr√©er un compte</button>
</div>

<!-- DASHBOARD USER -->
<div id="dash" class="hidden">
<div class="card" id="card">
<h2>GoPay ‚Ä¢ Virtual Card</h2>
<div class="card-number" id="cardId"></div>
<div class="card-row"><span>TITULAIRE</span><span>EXP</span></div>
<div class="card-row"><strong id="cardName"></strong><strong>12/29</strong></div>
<p>SOLDE : <b><span id="balance"></span> <span id="currency">USD</span></b></p>
</div>

<div class="actions">
<div class="action" onclick="openP('pay')">üí≥ Paiement</div>
<div class="action" onclick="openP('cashin')">‚ûï Cash-in</div>
<div class="action" onclick="openP('cashout')">‚ûñ Cash-out</div>
</div>

<!-- PAY -->
<div id="pay" class="panel hidden">
<input id="payId" placeholder="ID GoPay destinataire" oninput="fetchRecipientName('pay')">
<input id="payName" disabled placeholder="Nom destinataire">
<input id="payAmount" type="number" placeholder="Montant USD/CDF">
<select id="payCurrency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
<button onclick="pay()">Confirmer</button>
<div id="payQR"></div>
</div>

<!-- CASH-IN -->
<div id="cashin" class="panel hidden">
<input id="cinAmount" type="number" placeholder="Montant USD/CDF">
<select id="cinCurrency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
<button onclick="cashin()">Valider</button>
</div>

<!-- CASH-OUT -->
<div id="cashout" class="panel hidden">
<input id="coutId" placeholder="ID GoPay destinataire" oninput="fetchRecipientName('cout')">
<input id="coutName" disabled placeholder="Nom destinataire">
<input id="coutAmount" type="number" placeholder="Montant USD/CDF">
<select id="coutCurrency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
<button onclick="cashout()">Confirmer</button>
</div>

<!-- HISTORIQUE & ACTIVIT√âS -->
<div class="panel">
<h3>Activit√©s r√©centes</h3>
<div id="myTx"></div>
<h3 style="margin-top:20px">Activit√©s publiques</h3>
<div id="marketTx"></div>
</div>

<!-- ADMIN KYC -->
<div id="admin" class="panel hidden">
<h3>ADMIN ‚Äì Gestion KYC</h3>
<table id="usersTable"></table>
</div>

<!-- AGENT PANEL -->
<div id="agentPanel" class="panel hidden">
<h3>Agent Panel ‚Äì Suivi clients</h3>
<div id="agentClients"></div>
</div>

<footer>
<a onclick="show('legal')">Qui sommes-nous</a> |
<a onclick="show('faq')">FAQ</a> |
<a onclick="show('services')">Nos services</a> |
<a onclick="show('privacy')">Confidentialit√©</a> |
<a onclick="show('contact')">Contact</a>
</footer>
</main>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth=firebase.auth(),db=firebase.firestore();

/* NAVIGATION */
function toggleMenu(){menu.style.display=menu.style.display==="block"?"none":"block"}
function show(id){
 document.querySelectorAll(".panel,#dash").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id)?.classList.remove("hidden");
 menu.style.display="none";
}
function openP(id){
 ["pay","cashin","cashout"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

/* UTIL */
function genId(){return "GP-"+Math.random().toString(36).substr(2,8).toUpperCase()}

/* AUTH */
async function register(){
 const role=rRole.value;
 const cred = await auth.createUserWithEmailAndPassword(rEmail.value,rPass.value);
 await db.collection("users").doc(cred.user.uid).set({
  name:rName.value,
  email:rEmail.value,
  gid:genId(),
  balance:50,
  kyc: role==='client'?'none':'verified',
  role:role
 });
 alert("Compte cr√©√© ‚úÖ");
}

async function login(){
 if(!lEmail.value || !lPass.value){alert("Remplissez tous les champs");return;}
 const cred=await auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
 const snap=await db.collection("users").doc(auth.currentUser.uid).get();
 const d=snap.data();
 cardName.textContent=d.name;
 cardId.textContent=d.gid;
 balance.textContent=d.balance.toFixed(2);
 if(d.role==='admin'){document.getElementById('adminLink').style.display='block'; document.getElementById('agentLink').style.display='none'; show('admin');}
 else if(d.role==='agent'){document.getElementById('agentLink').style.display='block'; document.getElementById('adminLink').style.display='none'; show('agentPanel'); loadAgentClients();}
 else{document.getElementById('adminLink').style.display='none'; document.getElementById('agentLink').style.display='none'; show('dash');}
 generateQRCode(d.gid); loadMyTx();
}

/* CARD CLICK */
const card=document.getElementById("card");
card.onclick=()=>card.classList.toggle("flip");

/* TRANSACTION CHECK KYC */
async function canTransact(uid, amount){
 const snap = await db.collection("users").doc(uid).get();
 const u = snap.data();
 if(u.kyc==='none') return false;
 if(u.kyc==='pending' && amount>100) return false;
 return true;
}

/* PAYMENTS */
async function fetchRecipientName(t){
 const id=t==="pay"?payId.value:coutId.value;
 const f=t==="pay"?payName:coutName;
 if(!id){f.value="";return;}
 const q=await db.collection("users").where("gid","==",id).get();
 f.value=q.empty?"ID invalide":q.docs[0].data().name;
}

async function pay(){
 const amt=parseFloat(payAmount.value);
 if(!(await canTransact(auth.currentUser.uid, amt))){alert("KYC insuffisant"); return;}
 const me=await db.collection("users").doc(auth.currentUser.uid).get();
 const dest=await db.collection("users").where("gid","==",payId.value).get();
 if(dest.empty||me.data().balance<amt)return alert("Erreur");
 await db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(-amt)});
 await db.collection("users").doc(dest.docs[0].id).update({balance:firebase.firestore.FieldValue.increment(amt)});
 await db.collection("tx").add({from:me.data().gid,to:payId.value,type:"Paiement",amount:amt,date:new Date()});
 loadMyTx(); generateQRCode(payId.value);
}

async function cashin(){
 const amt=parseFloat(cinAmount.value);
 if(!(await canTransact(auth.currentUser.uid, amt))){alert("KYC insuffisant"); return;}
 await db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(amt)});
 await db.collection("tx").add({type:"Cash-in",amount:amt,date:new Date()});
 loadMyTx();
}

async function cashout(){
 const amt=parseFloat(coutAmount.value);
 if(!(await canTransact(auth.currentUser.uid, amt))){alert("KYC insuffisant"); return;}
 const me=await db.collection("users").doc(auth.currentUser.uid).get();
 const dest=await db.collection("users").where("gid","==",coutId.value).get();
 if(dest.empty||me.data().balance<amt)return alert("Erreur");
 await db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(-amt)});
 await db.collection("users").doc(dest.docs[0].id).update({balance:firebase.firestore.FieldValue.increment(amt)});
 await db.collection("tx").add({from:me.data().gid,to:coutId.value,type:"Cash-out",amount:amt,date:new Date()});
 loadMyTx();
}

/* ACTIVITES RECENTES */
async function loadMyTx(){
 myTx.innerHTML="";
 const snap=await db.collection("tx").where("from","==",cardId.textContent).orderBy("date","desc").limit(5).get();
 snap.forEach(d=>{const t=d.data(); myTx.innerHTML+=`<div class="tx">${t.type} ‚Ä¢ ${t.amount} USD/CDF</div>`});
}

/* PUBLIC MARKET TX */
const names=["Ali M.","Sarah L.","Jean K.","Mohamed A.","Linda S.","David R.","Fatou B.","Chris T."];
function marketFlow(){
 const tx=document.createElement("div");
 tx.className="tx";
 tx.innerHTML=`${names[Math.floor(Math.random()*names.length)]} ‚Ä¢ ${Math.random()>0.5?"Paiement":"Cash-out"} ‚Ä¢ ${(Math.random()*900+20).toFixed(2)} USD`;
 marketTx.prepend(tx);
 if(marketTx.children.length>6)marketTx.removeChild(marketTx.lastChild);
}
setInterval(marketFlow,3000);

/* QR CODE */
function generateQRCode(id){
 const container=payQR;
 container.innerHTML="";
 QRCode.toCanvas(container,id,{width:150,height:150},function(err){if(err)console.error(err)});
}

/* ADMIN KYC */
async function loadAdminKYC(){
 const table=document.getElementById("usersTable");
 table.innerHTML="<tr><th>Nom</th><th>Email</th><th>Solde</th><th>KYC</th><th>R√¥le</th><th>Actions</th></tr>";
 const users=await db.collection("users").get();
 users.forEach(doc=>{
  const u=doc.data();
  const row=document.createElement("tr");
  row.innerHTML=`<td>${u.name}</td><td>${u.email||'-'}</td><td>${u.balance}</td><td>${u.kyc||'none'}</td><td>${u.role}</td>
  <td>
   ${u.kyc!=='verified'?`<button class="admin-btn" onclick="verifyKYC('${doc.id}')">‚úîÔ∏è Valider</button>`:''}
   ${u.kyc==='pending'?`<button class="admin-btn" onclick="rejectKYC('${doc.id}')">‚ùå Refuser</button>`:''}
  </td>`;
  table.appendChild(row);
 });
}
async function verifyKYC(uid){await db.collection("users").doc(uid).update({kyc:'verified'}); loadAdminKYC(); alert("KYC valid√© ‚úÖ");}
async function rejectKYC(uid){await db.collection("users").doc(uid).update({kyc:'none'}); loadAdminKYC(); alert("KYC refus√© ‚ùå");}

/* AGENT PANEL */
async function loadAgentClients(){
 const container=document.getElementById("agentClients");
 container.innerHTML="";
 const users=await db.collection("users").where("role","==","client").get();
 users.forEach(doc=>{
  const u=doc.data();
  container.innerHTML+=`<div class="tx">${u.name} ‚Ä¢ ${u.gid} ‚Ä¢ Solde: ${u.balance} ‚Ä¢ KYC: ${u.kyc}</div>`;
 });
}

function logout(){auth.signOut();show("home"); document.getElementById('adminLink').style.display='none'; document.getElementById('agentLink').style.display='none';}
</script>
</body>
</html>
