<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoTrust Pay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{
 margin:0;font-family:Arial;
 background:linear-gradient(135deg,#021c1b,#032f2e);
 color:#d1fae5
}
.hidden{display:none}
header{padding:15px;background:#021c1b}
nav a{margin-right:15px;color:#99f6e4;font-weight:bold;cursor:pointer}
main{max-width:1100px;margin:auto;padding:20px}

input,button{
 width:100%;padding:12px;margin:6px 0;
 border-radius:10px;border:none
}
button{
 background:#14b8a6;font-weight:bold;cursor:pointer
}
.panel{
 background:#043837;padding:20px;border-radius:16px;margin-top:20px
}
.card{
 background:linear-gradient(145deg,#065f5b,#043837);
 padding:20px;border-radius:22px;
 display:flex;justify-content:space-between;
 box-shadow:0 10px 30px rgba(0,0,0,.6)
}
.actions{
 display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px
}
.action{
 background:linear-gradient(145deg,#0fb9a8,#087f73);
 padding:25px;border-radius:20px;
 text-align:center;font-weight:bold;
 box-shadow:0 8px 25px rgba(0,0,0,.6);
 cursor:pointer;transition:.2s
}
.action:hover{transform:scale(1.05)}
.activity{
 background:#022c2a;padding:10px;border-radius:8px;margin-bottom:6px
}
</style>
</head>

<body>

<header>
<nav>
 <a onclick="show('home')">Accueil</a>
 <a id="loginBtn" onclick="show('auth')">Connexion</a>
</nav>
</header>

<main>

<div id="home" class="panel">
 <h2>GoTrust Pay</h2>
 <p>Paiement digital s√©curis√©</p>
</div>

<div id="auth" class="panel hidden">
 <h2>Connexion / Inscription</h2>
 <input id="name" placeholder="Nom complet">
 <input id="phone" placeholder="T√©l√©phone">
 <input id="email" placeholder="Email">
 <input id="password" type="password" placeholder="Mot de passe">
 <button onclick="authUser()">Continuer</button>
</div>

<div id="dashboard" class="hidden">

<div class="card">
 <div>
  <h3 id="cardName"></h3>
  <p>Carte : <b id="cardNumber"></b></p>
  <p>ID : <span id="cardId"></span></p>
  <h2>Solde : <span id="balance"></span> USD</h2>
 </div>
 <div>
  <div id="qr" style="background:#fff;padding:8px;border-radius:10px"></div>
 </div>
</div>

<div class="actions">
 <div class="action" onclick="openPanel('deposit')">üí∞ D√©p√¥t</div>
 <div class="action" onclick="openPanel('withdraw')">üì§ Retrait</div>
 <div class="action" onclick="openPanel('send')">üîÅ Envoi</div>
 <div class="action" onclick="openPanel('messages')">üí¨ Messages</div>
</div>

<div id="deposit" class="panel hidden">
 <h3>D√©p√¥t</h3>
 <input id="depAmount" type="number" placeholder="Montant">
 <button onclick="deposit()">Confirmer</button>
</div>

<div id="withdraw" class="panel hidden">
 <h3>Retrait</h3>
 <input id="wdAmount" type="number" placeholder="Montant">
 <button onclick="withdraw()">Confirmer</button>
</div>

<div id="send" class="panel hidden">
 <h3>Envoi interne</h3>
 <input id="toUid" placeholder="ID destinataire">
 <input id="sendAmount" type="number" placeholder="Montant">
 <button onclick="send()">Envoyer</button>
</div>

<div id="messages" class="panel hidden">
 <h3>Messages</h3>
 <input id="msg" placeholder="Votre message">
 <button onclick="sendMsg()">Envoyer</button>
 <div id="msgList"></div>
</div>

</div>
</main>

<script>
// FIREBASE
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth=firebase.auth(),db=firebase.firestore();

function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

function genCard(){
 return "4896 "+
 Math.floor(7000+Math.random()*2999)+" "+
 Math.floor(1000+Math.random()*9000)+" "+
 Math.floor(1000+Math.random()*9000);
}

// AUTH SIMPLE ET FIABLE
function authUser(){
 const e=email.value,p=password.value;
 auth.signInWithEmailAndPassword(e,p)
 .catch(()=>{
  auth.createUserWithEmailAndPassword(e,p)
  .then(c=>{
   return db.collection("users").doc(c.user.uid).set({
    name:name.value,
    phone:phone.value,
    card:genCard(),
    balance:0
   });
  });
 });
}

auth.onAuthStateChanged(u=>{
 if(!u){show("home");return;}
 db.collection("users").doc(u.uid).get().then(d=>{
  const x=d.data();
  show("dashboard");
  loginBtn.classList.add("hidden");
  cardName.textContent=x.name;
  cardNumber.textContent=x.card;
  cardId.textContent=u.uid.slice(0,8);
  balance.textContent=x.balance.toFixed(2);
  qr.innerHTML="";
  new QRCode("qr",{text:x.card,width:130,height:130});
 });
});

function openPanel(id){
 ["deposit","withdraw","send","messages"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// OPERATIONS AVEC CONTROLE SOLDE
async function getBalance(){
 const d=await db.collection("users").doc(auth.currentUser.uid).get();
 return d.data().balance;
}

function deposit(){
 db.collection("users").doc(auth.currentUser.uid)
 .update({balance:firebase.firestore.FieldValue.increment(+depAmount.value)});
 alert("D√©p√¥t effectu√©");
}

async function withdraw(){
 const bal=await getBalance();
 if(+wdAmount.value>bal){alert("Solde insuffisant");return;}
 db.collection("users").doc(auth.currentUser.uid)
 .update({balance:firebase.firestore.FieldValue.increment(-wdAmount.value)});
 alert("Retrait effectu√©");
}

async function send(){
 const bal=await getBalance();
 if(+sendAmount.value>bal){alert("Solde insuffisant");return;}
 db.collection("users").doc(auth.currentUser.uid)
 .update({balance:firebase.firestore.FieldValue.increment(-sendAmount.value)});
 db.collection("users").doc(toUid.value)
 .update({balance:firebase.firestore.FieldValue.increment(+sendAmount.value)});
 alert("Envoi r√©ussi");
}

function sendMsg(){
 db.collection("messages").add({
  uid:auth.currentUser.uid,
  text:msg.value,
  date:new Date()
 });
 msg.value="";
}
</script>

</body>
</html>
