<!-- GOPAY PREMIUM FULL VERSION STABLE -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoPay Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{margin:0;font-family:Roboto;background:#061e1c;color:#e6fffa;}
header{background:#012b28;padding:12px 20px;display:flex;justify-content:space-between;}
.logo-text{font-size:22px;font-weight:700;color:#5eead4;}
.menu-btn{font-size:28px;cursor:pointer;}
.menu{display:none;position:absolute;top:60px;right:20px;background:#043837;border-radius:12px;}
.menu a{display:block;padding:12px;color:#5eead4;cursor:pointer;}
.menu a:hover{background:#065f5b;}

.panel{background:#043837;padding:20px;border-radius:18px;margin:20px;}
.hidden{display:none;}

.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px;}
.action{background:#14b8a6;padding:15px;border-radius:14px;text-align:center;font-weight:700;cursor:pointer;}

.cardVisual{
background:linear-gradient(45deg,#14b8a6,#0d9488);
padding:20px;border-radius:20px;margin-top:20px;
}
</style>
</head>

<body>

<header>
<div class="logo-text">GoPay Premium</div>
<div class="menu-btn" onclick="toggleMenu()">☰</div>
</header>

<div class="menu" id="menu">
<a onclick="show('home')">Accueil</a>
<a onclick="show('login')">Connexion</a>
<a id="adminBtn" class="hidden" onclick="openAdmin()">Admin Panel</a>
<a onclick="logout()">Déconnexion</a>
</div>

<!-- HOME -->
<div id="home" class="panel">
<h2>Banque Digitale Africaine</h2>
</div>

<!-- LOGIN -->
<div id="login" class="panel hidden">
<input id="lEmail" placeholder="Email">
<input id="lPass" type="password" placeholder="Mot de passe">
<button onclick="login()">Connexion</button>
<button onclick="show('register')">Créer compte</button>
</div>

<!-- REGISTER -->
<div id="register" class="panel hidden">
<input id="rName" placeholder="Nom">
<input id="rEmail" placeholder="Email">
<input id="rPass" type="password" placeholder="Mot de passe">

<select id="rRole">
<option value="client">Client</option>
<option value="agent">Agent</option>
</select>

<input type="file" id="avatarUpload">

<button onclick="register()">Créer compte</button>
</div>

<!-- DASHBOARD -->
<div id="dash" class="panel hidden">

<h3 id="cardName"></h3>
<p>ID : <span id="cardId"></span></p>

<select id="currencySelect" onchange="updateBalance()">
<option value="USD">USD</option>
<option value="CDF">CDF</option>
</select>

<p>Solde : <b id="balance"></b></p>

<div class="cardVisual">
<canvas id="qr"></canvas>
<img id="avatar" width="70" style="border-radius:50%;">
</div>

<div class="actions">
<div class="action" onclick="cashin()">Cash-in</div>
<div class="action" onclick="cashout()">Cash-out</div>
<div class="action" onclick="pay()">Paiement</div>
</div>

</div>

<!-- ADMIN -->
<div id="admin" class="panel hidden">
<h3>Panel Admin Sécurisé</h3>
<table id="usersTable"></table>
</div>

<script>

firebase.initializeApp({
apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
authDomain:"gotrustpay-e6524.firebaseapp.com",
projectId:"gotrustpay-e6524",
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentUserData=null;

/* MENU */
function toggleMenu(){
menu.style.display = menu.style.display==="block"?"none":"block";
}

function show(id){
menu.style.display="none";
document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
localStorage.setItem("lastPage",id);
}

/* REGISTER */
async function register(){

const avatarFile = avatarUpload.files[0];
let avatarBase64="";

if(avatarFile){
avatarBase64 = await toBase64(avatarFile);
}else{
avatarBase64="https://i.imgur.com/6VBx3io.png";
}

const cred = await auth.createUserWithEmailAndPassword(rEmail.value,rPass.value);

await db.collection("users").doc(cred.user.uid).set({
name:rName.value,
email:rEmail.value,
gid:"GP"+Math.random().toString(36).substr(2,6).toUpperCase(),
balanceUSD:50,
role:rRole.value,
avatar:avatarBase64
});

}

/* LOGIN */
async function login(){

const cred = await auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
const snap = await db.collection("users").doc(cred.user.uid).get();
loadUser(snap.data());
}

/* LOAD USER */
function loadUser(d){

currentUserData=d;

cardName.innerText=d.name;
cardId.innerText=d.gid;

avatar.src=d.avatar;

QRCode.toCanvas(document.getElementById("qr"), d.gid);

updateBalance();

if(d.role==="admin"){
adminBtn.classList.remove("hidden");
}

show("dash");
}

/* MULTI DEVISE */
function updateBalance(){

let cur=currencySelect.value;

if(cur==="USD"){
balance.innerText=currentUserData.balanceUSD.toFixed(2)+" USD";
}else{
balance.innerText=(currentUserData.balanceUSD*2500).toFixed(0)+" CDF";
}
}

/* CASH IN */
async function cashin(){

let amt=parseFloat(prompt("Montant USD"));
if(!amt) return;

await db.collection("users").doc(auth.currentUser.uid)
.update({balanceUSD:firebase.firestore.FieldValue.increment(amt)});

addHistory("Cash-in",amt);
}

/* CASH OUT */
async function cashout(){

let amt=parseFloat(prompt("Montant"));
if(!amt) return;

await db.collection("users").doc(auth.currentUser.uid)
.update({balanceUSD:firebase.firestore.FieldValue.increment(-amt)});

addHistory("Cash-out",amt);
}

/* PAY */
async function pay(){

let gid=prompt("ID destinataire");
let amt=parseFloat(prompt("Montant"));

const users=await db.collection("users").where("gid","==",gid).get();

if(users.empty){alert("Destinataire introuvable");return;}

const doc=users.docs[0];

await db.collection("users").doc(doc.id)
.update({balanceUSD:firebase.firestore.FieldValue.increment(amt)});

await db.collection("users").doc(auth.currentUser.uid)
.update({balanceUSD:firebase.firestore.FieldValue.increment(-amt)});

addHistory("Paiement",amt);
}

/* HISTORIQUE */
function addHistory(type,amt){
db.collection("history").add({
uid:auth.currentUser.uid,
type:type,
amount:amt,
date:new Date()
});
}

/* ADMIN */
async function openAdmin(){

const snap=await db.collection("users").get();

usersTable.innerHTML="<tr><th>Nom</th><th>Email</th><th>Solde</th></tr>";

snap.forEach(doc=>{
const u=doc.data();
usersTable.innerHTML+=`<tr><td>${u.name}</td><td>${u.email}</td><td>${u.balanceUSD}</td></tr>`;
});

show("admin");
}

/* PERSISTENCE PAGE */
auth.onAuthStateChanged(async user=>{
if(user){
const snap=await db.collection("users").doc(user.uid).get();
loadUser(snap.data());

let last=localStorage.getItem("lastPage");
if(last) show(last);
}
});

/* LOGOUT */
function logout(){
auth.signOut();
}

/* BASE64 */
function toBase64(file){
return new Promise((res,rej)=>{
let r=new FileReader();
r.onload=()=>res(r.result);
r.onerror=rej;
r.readAsDataURL(file);
});
}

</script>

</body>
</html>
