<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoTrust Pay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Styles -->
<style>
body{margin:0;font-family:Arial;background:linear-gradient(135deg,#021c1b,#032f2e);color:#d1fae5}
.hidden{display:none!important}
header{padding:15px;background:#021c1b}
nav a{margin-right:15px;color:#99f6e4;font-weight:bold;cursor:pointer}
main{max-width:1100px;margin:auto;padding:20px}
input,select,button{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:none}
button{background:#14b8a6;font-weight:bold;cursor:pointer}
.panel{background:#043837;padding:20px;border-radius:16px;margin-top:20px}
.actions{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
@media(max-width:700px){.actions{grid-template-columns:repeat(2,1fr)}}
.action{background:linear-gradient(145deg,#0fb9a8,#087f73);padding:22px;border-radius:18px;text-align:center;font-weight:bold;cursor:pointer}
.tx,.news{background:#022c2a;padding:8px;border-radius:8px;margin-bottom:6px}
.card{
  width:320px;
  height:180px;
  background:linear-gradient(135deg,#065f5b,#043837);
  border-radius:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.7);
  padding:20px;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
  flex-wrap:wrap;
}
.card::before{
  content:"";
  position:absolute;
  top:10px;
  right:10px;
  width:40px;
  height:40px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
}
#qr{
  width:120px;
  height:120px;
  background:#fff;
  padding:8px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>

<header>
<nav>
 <a onclick="show('home')">Accueil</a>
 <a id="loginBtnNav" onclick="show('loginPanel')">Connexion</a>
 <a id="registerBtnNav" onclick="show('registerPanel')">Inscription</a>
 <a id="logoutBtn" class="hidden" onclick="logout()">D√©connexion</a>
</nav>
</header>

<main>
<!-- Accueil -->
<div id="home" class="panel">
 <h2>GoTrust Pay</h2>
 <p>Paiement digital s√©curis√©</p>
 <h3>Actualit√©s r√©centes</h3>
 <div id="newsList"></div>
</div>

<!-- Login -->
<div id="loginPanel" class="panel hidden">
 <h3>Connexion</h3>
 <input id="loginEmail" placeholder="Email">
 <input id="loginPassword" type="password" placeholder="Mot de passe">
 <button onclick="login()">Se connecter</button>
</div>

<!-- Register -->
<div id="registerPanel" class="panel hidden">
 <h3>Inscription</h3>
 <input id="regName" placeholder="Nom complet">
 <input id="regPhone" placeholder="T√©l√©phone">
 <input id="regEmail" placeholder="Email">
 <input id="regPassword" type="password" placeholder="Mot de passe">
 <button onclick="register()">S'inscrire</button>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">

<div class="card">
  <div>
    <h3 id="cardName" style="margin:0;font-size:1.2em;"></h3>
    <p style="margin:4px 0;">Carte biom√©trique</p>
    <div id="cardNumber" style="font-size:1.1em;letter-spacing:2px;"></div>
    <small>ID : <span id="cardId"></span></small>
    <h2 style="margin-top:10px;font-size:1.1em;">Solde : <span id="balance"></span> USD</h2>
  </div>
  <div id="qr"></div>
</div>

<h3>Activit√©s r√©centes</h3>
<div id="recentTx"></div>

<div class="actions">
 <div class="action" onclick="openPanel('deposit')">üí∞ D√©p√¥t</div>
 <div class="action" onclick="openPanel('withdraw')">üì§ Retrait</div>
 <div class="action" onclick="openPanel('send')">üîÅ Envoi</div>
 <div class="action" onclick="openPanel('history')">üìú Historique</div>
</div>

<div id="deposit" class="panel hidden">
 <select id="depOperator">
   <option value="Orange">Orange</option>
   <option value="Airtel">Airtel</option>
   <option value="GoPay">GoPay</option>
 </select>
 <input id="depAmount" type="number" placeholder="Montant USD">
 <button onclick="deposit()">Confirmer</button>
</div>

<div id="withdraw" class="panel hidden">
 <select id="wdOperator">
   <option value="Orange">Orange</option>
   <option value="Airtel">Airtel</option>
   <option value="GoPay">GoPay</option>
 </select>
 <input id="wdAmount" type="number" placeholder="Montant RWF">
 <button onclick="withdraw()">Confirmer</button>
</div>

<div id="send" class="panel hidden">
 <input id="toUid" placeholder="ID destinataire">
 <input id="sendAmount" type="number" placeholder="Montant USD">
 <button onclick="send()">Envoyer</button>
</div>

<div id="history" class="panel hidden">
 <h3>Historique complet</h3>
 <div id="txList"></div>
</div>

</main>

<!-- SCRIPT -->
<script>
// Firebase init
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth=firebase.auth(),db=firebase.firestore();
const RATE=1300;

// UI
function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// Auth
function register(){
 auth.createUserWithEmailAndPassword(regEmail.value,regPassword.value)
 .then(c=>db.collection("users").doc(c.user.uid).set({
  name:regName.value, phone:regPhone.value,
  card:genCard(), balance:0
 })).catch(e=>alert(e.message));
}
function login(){
 auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value)
 .catch(e=>alert(e.message));
}
function logout(){auth.signOut()}

// Card generator
function genCard(){return "4896 "+Math.floor(7000+Math.random()*2999)+" "+Math.floor(1000+Math.random()*9000)+" "+Math.floor(1000+Math.random()*9000);}

// Auth state
auth.onAuthStateChanged(async u=>{
 if(!u){loginBtnNav.classList.remove("hidden");registerBtnNav.classList.remove("hidden");logoutBtn.classList.add("hidden");show("home");loadNews();return;}
 loginBtnNav.classList.add("hidden");registerBtnNav.classList.add("hidden");logoutBtn.classList.remove("hidden");

 const d=await db.collection("users").doc(u.uid).get(); const x=d.data();
 show("dashboard"); cardName.textContent=x.name; cardNumber.textContent=x.card; cardId.textContent=u.uid.slice(0,8); balance.textContent=x.balance.toFixed(2);
 qr.innerHTML=""; new QRCode(qr,{text:x.card,width:120,height:120});

 loadRecent();loadHistory();
 setInterval(()=>{loadRecent();loadNews();},3000);
});

// Panels
function openPanel(id){
 ["deposit","withdraw","send","history"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// Transactions
async function addTx(type,amount,operator){
 await db.collection("transactions").add({uid:auth.currentUser.uid,type,amount,operator,date:new Date()});
 loadRecent();loadHistory();
}
function deposit(){
 const operator = depOperator.value;
 const amount = +depAmount.value;
 db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(amount)});
 addTx("D√©p√¥t", amount, operator);
}
async function withdraw(){
 const operator = wdOperator.value;
 const amountRWF = +wdAmount.value;
 const usd = amountRWF / RATE;
 const d=await db.collection("users").doc(auth.currentUser.uid).get();
 if(usd>d.data().balance)return alert("Solde insuffisant");
 db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(-usd)});
 addTx("Retrait", -usd, operator);
}
async function send(){
 const d=await db.collection("users").doc(auth.currentUser.uid).get();
 if(sendAmount.value>d.data().balance)return alert("Solde insuffisant");
 db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(-sendAmount.value)});
 db.collection("users").doc(toUid.value).update({balance:firebase.firestore.FieldValue.increment(+sendAmount.value)});
 addTx("Envoi",-sendAmount.value,"Interne");
}

// Historique & activit√©s
async function loadRecent(){
 recentTx.innerHTML="";
 const q=await db.collection("transactions")
    .where("uid","==",auth.currentUser.uid)
    .orderBy("date","desc")
    .limit(5).get();
 if(q.empty){recentTx.innerHTML="<div class='tx'>Aucune activit√© r√©cente</div>";return;}
 q.forEach(d=>{
   const t = d.data();
   const date = new Date(t.date.seconds*1000).toLocaleString();
   recentTx.innerHTML += `<div class="tx">${t.type} : ${t.amount.toFixed(2)} USD (${t.operator})<br><small>${date}</small></div>`;
 });
}

async function loadHistory(){
 txList.innerHTML="";
 const q=await db.collection("transactions")
    .where("uid","==",auth.currentUser.uid)
    .orderBy("date","desc").get();
 if(q.empty){txList.innerHTML="<div class='tx'>Aucune transaction</div>";return;}
 q.forEach(d=>{
   const t = d.data();
   const date = new Date(t.date.seconds*1000).toLocaleString();
   txList.innerHTML += `<div class="tx">${t.type} : ${t.amount.toFixed(2)} USD (${t.operator})<br><small>${date}</small></div>`;
 });
}

// Actualit√©s
async function loadNews(){
 newsList.innerHTML="";
 const q = await db.collection("annonces").orderBy("date","desc").limit(3).get();
 q.forEach(d=>{
   newsList.innerHTML += `<div class="news">${d.data().text}</div>`;
 });
}
</script>

</body>
</html>
