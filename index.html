<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoTrust Pay</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
 --panel:#043837;--accent:#14b8a6;--text:#d1fae5;
}
body{
 margin:0;font-family:Arial;
 background:linear-gradient(135deg,#021c1b,#032f2e);
 color:var(--text);
}
.hidden{display:none}
header{background:#021c1b;padding:15px}
nav a{color:#99f6e4;margin-right:20px;cursor:pointer;font-weight:bold}
main{max-width:1200px;margin:auto;padding:20px}
button{background:var(--accent);border:none;padding:10px;border-radius:8px;font-weight:bold}
input,select{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none}
.panel{background:var(--panel);padding:20px;border-radius:14px;margin-top:20px}
.card{background:#054a48;padding:20px;border-radius:18px;display:flex;justify-content:space-between}
.activity{background:#022c2a;padding:10px;border-radius:8px;margin-bottom:6px}
.tabs button{margin-right:10px}
</style>
</head>

<body>

<header>
<nav>
 <a onclick="show('home')">Accueil</a>
 <a onclick="show('login')">Connexion</a>
 <a id="adminBtn" class="hidden" onclick="show('admin')">Admin</a>
</nav>
</header>

<main>

<!-- HOME -->
<div id="home">
 <div class="panel">
  <h2>Activités récentes</h2>
  <div id="activities"></div>
 </div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden panel">
 <h2>Connexion</h2>
 <input id="email" placeholder="Email">
 <input id="password" type="password" placeholder="Mot de passe">
 <button onclick="login()">Connexion</button>

 <h3>Créer un compte</h3>
 <input id="name" placeholder="Nom complet">
 <input id="phone" placeholder="Téléphone">
 <input id="regEmail" placeholder="Email">
 <input id="regPass" type="password" placeholder="Mot de passe">
 <button onclick="register()">Créer</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
 <div>
  <h3 id="cardName"></h3>
  <p>ID : <span id="cardId"></span></p>
  <p>Carte : <span id="cardNumber"></span></p>
  <b>Solde : <span id="balance"></span> USD</b>
 </div>
 <div>
  <div id="clientQR" style="background:#fff;padding:6px"></div>
  <button onclick="downloadQR()">QR</button>
 </div>
</div>

<!-- NAV DASHBOARD -->
<div class="panel tabs">
 <button onclick="dash('deposit')">Dépôt</button>
 <button onclick="dash('withdraw')">Retrait</button>
 <button onclick="dash('transfer')">Transfert</button>
 <button onclick="dash('messages')">Messages</button>
</div>

<!-- DEPOT -->
<div id="deposit" class="panel">
 <h3>Dépôt</h3>
 <input id="mmPhone" placeholder="Téléphone">
 <input id="mmAmount" type="number" placeholder="Montant">
 <button onclick="mobileDeposit()">Confirmer</button>
</div>

<!-- RETRAIT -->
<div id="withdraw" class="panel hidden">
 <h3>Retrait</h3>
 <input id="wdPhone" placeholder="Téléphone">
 <input id="wdAmount" type="number" placeholder="Montant">
 <button onclick="withdraw()">Retirer</button>
</div>

<!-- TRANSFERT -->
<div id="transfer" class="panel hidden">
 <h3>Transfert interne</h3>
 <input id="toUid" placeholder="UID destinataire">
 <input id="trAmount" type="number" placeholder="Montant">
 <button onclick="transfer()">Envoyer</button>
</div>

<!-- MESSAGES -->
<div id="messages" class="panel hidden">
 <h3>Messages / Support</h3>
 <input id="msgText" placeholder="Votre message">
 <button onclick="sendMsg()">Envoyer</button>
 <div id="msgList"></div>
</div>

<!-- HISTORIQUE -->
<div class="panel">
 <h3>Historique</h3>
 <div id="history"></div>
</div>

</div>

<!-- ADMIN -->
<div id="admin" class="hidden panel">
 <h2>Admin – Dépôts récents</h2>
 <div id="adminDeposits"></div>
</div>

</main>

<script>
// FIREBASE
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth=firebase.auth(),db=firebase.firestore();

function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

function dash(id){
 ["deposit","withdraw","transfer","messages"].forEach(x=>document.getElementById(x).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

function genCard(){return "4896 "+Math.floor(1000+Math.random()*9000)+" **** ****";}

function register(){
 auth.createUserWithEmailAndPassword(regEmail.value,regPass.value)
 .then(c=>db.collection("users").doc(c.user.uid).set({
  name:name.value,phone:phone.value,card:genCard(),balance:0,role:"client"
 }));
}

function login(){
 auth.signInWithEmailAndPassword(email.value,password.value)
 .then(()=>{email.value="";password.value="";});
}

auth.onAuthStateChanged(u=>{
 if(!u){show("home");return;}
 db.collection("users").doc(u.uid).get().then(d=>{
  const x=d.data();show("dashboard");
  cardName.textContent=x.name;
  cardId.textContent=u.uid.slice(0,8);
  cardNumber.textContent=x.card;
  balance.textContent=x.balance.toFixed(2);
  if(x.role==="admin")adminBtn.classList.remove("hidden");
  clientQR.innerHTML="";new QRCode("clientQR",{text:u.uid,width:120,height:120});
  loadHistory();loadMessages();loadAdmin();
 });
 loadActivities();
});

// DEPOT
function mobileDeposit(){
 const a=Number(mmAmount.value),uid=auth.currentUser.uid;
 db.collection("users").doc(uid).update({balance:firebase.firestore.FieldValue.increment(a)});
 db.collection("deposits").add({uid,amount:a,date:new Date()});
 alert("Dépôt OK");loadHistory();
}

// RETRAIT
function withdraw(){
 const a=Number(wdAmount.value),uid=auth.currentUser.uid;
 db.collection("users").doc(uid).update({balance:firebase.firestore.FieldValue.increment(-a)});
 alert("Retrait demandé");loadHistory();
}

// TRANSFERT
function transfer(){
 const a=Number(trAmount.value);
 db.collection("users").doc(auth.currentUser.uid)
 .update({balance:firebase.firestore.FieldValue.increment(-a)});
 db.collection("users").doc(toUid.value)
 .update({balance:firebase.firestore.FieldValue.increment(a)});
 alert("Transfert effectué");loadHistory();
}

// MESSAGES
function sendMsg(){
 db.collection("messages").add({
  uid:auth.currentUser.uid,
  text:msgText.value,
  date:new Date()
 });
 msgText.value="";loadMessages();
}
function loadMessages(){
 msgList.innerHTML="";
 db.collection("messages").where("uid","==",auth.currentUser.uid)
 .orderBy("date","desc").get().then(s=>{
  s.forEach(d=>msgList.innerHTML+=`<div class="activity">${d.data().text}</div>`);
 });
}

// HISTORIQUE
function loadHistory(){
 history.innerHTML="";
 db.collection("deposits").where("uid","==",auth.currentUser.uid)
 .get().then(s=>s.forEach(d=>history.innerHTML+=`<div class="activity">+${d.data().amount} USD</div>`));
}

// ADMIN
function loadAdmin(){
 adminDeposits.innerHTML="";
 db.collection("deposits").orderBy("date","desc").limit(10).get()
 .then(s=>s.forEach(d=>adminDeposits.innerHTML+=`<div class="activity">${d.data().amount} USD</div>`));
}

// ACTIVITÉS
function loadActivities(){
 activities.innerHTML="";
 for(let i=0;i<10;i++)activities.innerHTML+=`<div class="activity">Transaction ${Math.floor(Math.random()*900000)}</div>`;
 setTimeout(loadActivities,3000);
}

function downloadQR(){
 const c=document.querySelector("#clientQR canvas");
 const a=document.createElement("a");
 a.href=c.toDataURL();a.download="qr.png";a.click();
}
</script>

</body>
</html>
