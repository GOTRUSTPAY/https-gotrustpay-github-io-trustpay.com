
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoTrust Pay - MVP Amélioré</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- jsPDF pour la carte PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{--bg:#021c1b;--panel:#043837;--card:#065f5b;--accent:#14b8a6;--text:#d1fae5}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#021c1b,#032f2e);color:var(--text)}
header{background:#021c1b;padding:15px 25px;display:flex;justify-content:space-between}
nav a{color:#99f6e4;margin-left:20px;font-weight:bold;cursor:pointer;text-decoration:none}
main{max-width:1200px;margin:25px auto;padding:20px}
.hidden{display:none}
button{background:var(--accent);border:none;padding:10px 16px;border-radius:8px;font-weight:bold;cursor:pointer}
input,select{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none}
.panel{background:var(--panel);border-radius:14px;padding:20px;margin-top:20px}
.card{background:linear-gradient(135deg,#054a48,#022c2a);border-radius:18px;padding:25px;display:flex;justify-content:space-between;box-shadow:0 10px 30px rgba(0,0,0,.6)}
.chip{width:50px;height:38px;background:linear-gradient(135deg,#facc15,#eab308);border-radius:6px;margin-bottom:10px}
.activity{background:#022c2a;padding:10px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;font-size:14px}
.small{font-size:13px;opacity:.8}
.badge{padding:3px 8px;border-radius:6px;font-size:12px}
.ok{background:#14532d}
.wait{background:#7c2d12}
.no{background:#7f1d1d}
</style>
</head>
<body>

<header>
  <nav>
    <a onclick="show('home')">Accueil</a>
    <a onclick="show('login')">Connexion</a>
    <a id="adminBtn" class="hidden">Admin</a>
    <button onclick="downloadLogo()">Logo PNG</button>
  </nav>
</header>

<main>

<!-- HOME -->
<div id="home">
  <div class="panel">
    <h2>Activités récentes</h2>
    <div id="activities"></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden panel">
  <h2>Connexion</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password">
  <button onclick="login()">Connexion</button>

  <h3>Créer un compte</h3>
  <input id="name" placeholder="Nom complet">
  <input id="phone" placeholder="Téléphone">
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password">
  <button onclick="register()">Créer</button>
</div>

<!-- DASHBOARD CLIENT -->
<div id="dashboard" class="hidden">

  <div class="card">
    <div>
      <div class="chip"></div>
      <h3 id="cardName"></h3>
      <p>ID : <span id="cardId"></span></p>
      <p>Carte : <span id="cardNumber"></span></p>
      <p><b>Solde : <span id="balance"></span> USD</b></p>
    </div>
    <div>
      <div id="clientQR" style="background:#fff;padding:6px;border-radius:8px"></div>
      <button onclick="downloadQR()">Télécharger QR</button>
      <button onclick="downloadCardPDF()">Télécharger carte PDF</button>
    </div>
  </div>

  <div class="panel">
    <h3>Dépôt Mobile Money</h3>
    <select id="mmType">
      <option>Airtel Money</option>
      <option>Orange Money</option>
      <option>Vodacom M-Pesa</option>
      <option>GoPay</option>
    </select>
    <input id="mmPhone" placeholder="Numéro">
    <input id="mmAmount" type="number" placeholder="Montant">
    <button onclick="mobileDeposit()">Déposer</button>
    <p class="small">Anti‑double paiement actif</p>
  </div>

  <div class="panel">
    <h3>KYC (vérification)</h3>
    <input type="file" id="idFile">
    <input type="file" id="selfieFile">
    <button onclick="submitKYC()">Envoyer KYC</button>
    <p id="kycStatus" class="small"></p>
  </div>

  <div class="panel">
    <h3>Historique dépôts</h3>
    <div id="history"></div>
  </div>

</div>

<!-- ADMIN -->
<div id="admin" class="hidden panel">
  <h2>Admin – Dépôts à valider</h2>
  <div id="adminDeposits"></div>
</div>

</main>

<script>
window.addEventListener("DOMContentLoaded",()=>{

// ===== Firebase =====
firebase.initializeApp({
 apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
 authDomain:"gotrustpay-e6524.firebaseapp.com",
 projectId:"gotrustpay-e6524"
});
const auth = firebase.auth();
const db = firebase.firestore();
let lastDeposit=0;

// ===== Elements =====
const email=document.getElementById("email");
const password=document.getElementById("password");
const regEmail=document.getElementById("regEmail");
const regPass=document.getElementById("regPass");
const nameInput=document.getElementById("name");
const phoneInput=document.getElementById("phone");
const mmAmount=document.getElementById("mmAmount");
const mmPhone=document.getElementById("mmPhone");
const mmType=document.getElementById("mmType");
const cardName=document.getElementById("cardName");
const cardId=document.getElementById("cardId");
const cardNumber=document.getElementById("cardNumber");
const balance=document.getElementById("balance");
const kycStatus=document.getElementById("kycStatus");
const clientQR=document.getElementById("clientQR");
const historyDiv=document.getElementById("history");
const adminBtn=document.getElementById("adminBtn");
const adminDeposits=document.getElementById("adminDeposits");
const activitiesDiv=document.getElementById("activities");
const idFile=document.getElementById("idFile");
const selfieFile=document.getElementById("selfieFile");

// ===== NAV =====
function show(id){
 document.querySelectorAll("main>div").forEach(d=>d.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}

// ===== REGISTER =====
function genCard(){return "4896 "+Math.floor(1000+Math.random()*9000)+" **** ****";}
async function register(){
 try {
   if(!regEmail.value || !regPass.value || !nameInput.value) return alert("Champs requis");
   const cred = await auth.createUserWithEmailAndPassword(regEmail.value,regPass.value);
   await db.collection("users").doc(cred.user.uid).set({
     name:nameInput.value,
     phone:phoneInput.value,
     card:genCard(),
     balance:0,
     role:"client",
     kyc:"none",
     createdAt:firebase.firestore.FieldValue.serverTimestamp()
   });
   nameInput.value=phoneInput.value=regEmail.value=regPass.value="";
   show("dashboard");
 } catch(e){ alert("Erreur inscription : "+e.message); }
}

// ===== LOGIN =====
async function login(){
 try {
   await auth.signInWithEmailAndPassword(email.value,password.value);
   email.value=password.value="";
 } catch(e){ alert("Erreur connexion : "+e.message); }
}

// ===== AUTH STATE =====
auth.onAuthStateChanged(user=>{
 if(!user){show("home"); adminBtn.classList.add("hidden"); return;}
 show("dashboard");

 const userRef = db.collection("users").doc(user.uid);
 userRef.onSnapshot(doc=>{
   if(!doc.exists) return;
   const x=doc.data();
   cardName.textContent=x.name;
   cardId.textContent=user.uid.slice(0,10).toUpperCase();
   cardNumber.textContent=x.card;
   balance.textContent=x.balance.toFixed(2);
   kycStatus.textContent="KYC : "+x.kyc;
   if(x.role==="admin") adminBtn.classList.remove("hidden"); else adminBtn.classList.add("hidden");

   clientQR.innerHTML="";
   new QRCode(clientQR,{text:user.uid,width:130,height:130});
 });

 loadHistory(user.uid);
 if(user.uid==="UID_ADMIN_TEST") loadAdmin(); // remplace par UID réel admin
 loadActivities();
});

// ===== DEPOT =====
async function mobileDeposit(){
 if(!auth.currentUser) return alert("Vous devez être connecté");
 if(Date.now()-lastDeposit<10000) return alert("Double paiement bloqué");
 lastDeposit=Date.now();
 const uid=auth.currentUser.uid;
 const amount=parseFloat(mmAmount.value);
 if(isNaN(amount) || amount<=0) return alert("Montant invalide");
 await db.collection("deposits").add({
   uid, amount, phone:mmPhone.value, method:mmType.value,
   status:"pending", date:firebase.firestore.FieldValue.serverTimestamp()
 });
 mmAmount.value=mmPhone.value="";
 alert("Dépôt envoyé, attente validation admin");
}

// ===== HISTORIQUE =====
function loadHistory(uid){
 db.collection("deposits").where("uid","==",uid).orderBy("date","desc")
 .onSnapshot(s=>{
   historyDiv.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     historyDiv.innerHTML+=`<div class="activity">${x.method} ${x.amount} USD
      <span class="badge ${x.status==="approved"?"ok":x.status==="rejected"?"no":"wait"}">${x.status}</span></div>`;
   });
 });
}

// ===== ADMIN =====
function loadAdmin(){
 adminDeposits.innerHTML="";
 db.collection("deposits").where("status","==","pending").onSnapshot(s=>{
   adminDeposits.innerHTML="";
   s.forEach(d=>{
     const x=d.data();
     adminDeposits.innerHTML+=`<div class="activity">${x.method} ${x.amount} USD
       <span>
         <button onclick="approve('${d.id}','${x.uid}',${x.amount})">✔</button>
         <button onclick="reject('${d.id}')">✖</button>
       </span>
     </div>`;
   });
 });
}
function approve(id,uid,amt){
 db.collection("deposits").doc(id).update({status:"approved"});
 db.collection("users").doc(uid).update({balance:firebase.firestore.FieldValue.increment(amt)});
}
function reject(id){
 db.collection("deposits").doc(id).update({status:"rejected"});
}

// ===== KYC =====
async function submitKYC(){
 if(!auth.currentUser) return alert("Vous devez être connecté");
 if(!idFile.files[0] || !selfieFile.files[0]) return alert("Choisissez les fichiers");
 await db.collection("users").doc(auth.currentUser.uid).update({kyc:"submitted"});
 alert("KYC envoyé");
}

// ===== ACTIVITES =====
function loadActivities(){
 activitiesDiv.innerHTML="";
 const names=["Amina","Patrick","Sofia","Daniel","Ali","Emma","Jean"];
 for(let i=0;i<10;i++){
   activitiesDiv.innerHTML+=`<div class="activity">${names[Math.floor(Math.random()*names.length)]} transaction
     <span>${Math.floor(Math.random()*900000+100000)}</span></div>`;
 }
 setTimeout(loadActivities,3000);
}

// ===== QR =====
function downloadQR(){
 const c=document.querySelector("#clientQR canvas");
 if(!c) return alert("QR non généré");
 const a=document.createElement("a");
 a.href=c.toDataURL();
 a.download="qr.png";
 a.click();
}

// ===== CARTE PDF =====
async function downloadCardPDF(){
 if(!auth.currentUser) return alert("Connectez-vous");
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();
 doc.setFillColor(5, 74, 72);
 doc.rect(10, 20, 190, 100, "F");
 doc.setTextColor(255,255,255);
 doc.setFontSize(16);
 doc.text(`Nom : ${cardName.textContent}`,20,40);
 doc.text(`ID : ${cardId.textContent}`,20,55);
 doc.text(`Carte : ${cardNumber.textContent}`,20,70);
 doc.text(`Solde : ${balance.textContent} USD`,20,85);

 // QR code dans PDF
 const canvas=document.querySelector("#clientQR canvas");
 if(canvas){
   const imgData = canvas.toDataURL("image/png");
   doc.addImage(imgData,'PNG',140,40,50,50);
 }
 doc.save("carte_gotrustpay.pdf");
}

// ===== LOGO PNG =====
function downloadLogo(){
 const canvas=document.createElement("canvas");
 canvas.width=300; canvas.height=80;
 const ctx=canvas.getContext("2d");
 ctx.fillStyle="#021c1b"; ctx.fillRect(0,0,300,80);
 ctx.fillStyle="#14b8a6"; ctx.font="bold 40px Arial";
 ctx.fillText("GoTrust Pay",20,55);
 const a=document.createElement("a"); a.href=canvas.toDataURL(); a.download="gotrustpay-logo.png"; a.click();
}

// ===== ADMIN BUTTON =====
adminBtn.addEventListener("click",()=>{
 if(adminBtn.classList.contains("hidden")){ alert("Accès refusé"); show("dashboard"); return;}
 show("admin");
});

});
</script>

</body>
</html>
