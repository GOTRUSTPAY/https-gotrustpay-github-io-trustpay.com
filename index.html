<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GOPAY AFRICA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{
margin:0;
font-family:Roboto;
background:#061e1c;
color:white;
}

header{
background:#012b28;
padding:12px 20px;
display:flex;
justify-content:space-between;
align-items:center;
}

.logo{
font-size:22px;
font-weight:bold;
color:#5eead4;
}

.panel{
background:#043837;
margin:20px;
padding:20px;
border-radius:18px;
}

.hidden{display:none;}

.actions{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
gap:10px;
margin-top:20px;
}

.action{
background:#14b8a6;
padding:12px;
border-radius:12px;
text-align:center;
font-weight:bold;
cursor:pointer;
}

.card{
background:linear-gradient(135deg,#1d4ed8,#0ea5e9);
border-radius:20px;
padding:20px;
}
</style>
</head>

<body>

<header>
<div class="logo">GOPAY AFRICA</div>
</header>

<!-- LOGIN -->
<div id="login" class="panel">
<h3>Connexion</h3>
<input id="lEmail" placeholder="Email"><br><br>
<input id="lPass" type="password" placeholder="Mot de passe"><br><br>
<div class="action" onclick="login()">Connexion</div>
</div>

<!-- DASHBOARD -->
<div id="dash" class="panel hidden">

<div class="card">
<h3 id="cardName"></h3>
<small>ID : <span id="cardId"></span></small>
<h2>$ <span id="balance"></span></h2>
<canvas id="qr"></canvas>
</div>

<div class="actions">
<div class="action" onclick="cashin()">Cash-in</div>
<div class="action" onclick="cashout()">Cash-out</div>
<div class="action" onclick="pay()">Paiement</div>
<div class="action" onclick="openKYC()">KYC</div>
<div class="action" onclick="logout()">Déconnexion</div>
</div>

<div id="history"></div>

</div>

<script>

/* ===== FIREBASE ===== */
firebase.initializeApp({
apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
authDomain:"gotrustpay-e6524.firebaseapp.com",
projectId:"gotrustpay-e6524",
});

const auth=firebase.auth();
const db=firebase.firestore();
let currentUser=null;

/* ===== LOGIN ===== */
async function login(){
const cred=await auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
loadUserData(cred.user.uid);
}

/* ===== SESSION MULTI-APPAREIL ===== */
async function loadUserData(uid){

const snap=await db.collection("users").doc(uid).get();
currentUser=snap.data();

if(currentUser.sessionToken && currentUser.sessionToken!==uid){
alert("Session active sur un autre appareil");
logout();
}
else{
await db.collection("users").doc(uid).update({sessionToken:uid});
loadUser(currentUser);
}
}

/* ===== LOAD USER ===== */
function loadUser(user){

cardName.innerText=user.name;
cardId.innerText=user.gid;
balance.innerText=user.balance.toFixed(2);

QRCode.toCanvas(qr,user.gid);

document.getElementById("login").classList.add("hidden");
document.getElementById("dash").classList.remove("hidden");

loadHistory();
}

/* ===== NOTIFICATION ===== */
function notifyUser(msg){
alert("Notification GoPay : "+msg);
}

/* ===== TRANSACTION LOG ===== */
function saveTransaction(userId,type,amount){
db.collection("transactions").add({
userId,
type,
amount,
date:new Date()
});
}

/* ===== KYC ===== */
function submitKYC(userId,docURL){
db.collection("kyc").doc(userId).set({
document:docURL,
status:"pending"
});
notifyUser("KYC envoyé");
}

function openKYC(){
let doc=prompt("Lien document KYC");
submitKYC(currentUser.gid,doc);
}

/* ===== HISTORIQUE CLIENT ===== */
async function loadHistory(){

history.innerHTML="";

const snap=await db.collection("transactions")
.where("userId","==",currentUser.gid)
.get();

snap.forEach(t=>{
let d=t.data();
history.innerHTML+=`<p>${d.type} : $${d.amount}</p>`;
});
}

/* ===== AVATAR ===== */
function generateAvatar(name){
return `https://ui-avatars.com/api/?name=${name}&background=0D8ABC&color=fff`;
}

/* ===== CARTE BIOMETRIQUE ===== */
function generateCard(){
return{
cardNumber:"5314 "+Math.floor(1000+Math.random()*9000)+" "+
Math.floor(1000+Math.random()*9000)+" "+
Math.floor(1000+Math.random()*9000),
biometricCode:Math.floor(100000 + Math.random()*900000)
};
}

/* ===== MULTI DEVISE ===== */
const exchangeRates={USD:1,CDF:2800};

function convertCurrency(amount,from,to){
return (amount/exchangeRates[from])*exchangeRates[to];
}

/* ===== CASH IN ===== */
async function cashin(){
let amt=parseFloat(prompt("Montant"));
await db.collection("users").doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(amt)});
saveTransaction(currentUser.gid,"cashin",amt);
notifyUser("Cash-in réussi");
}

/* ===== CASH OUT ===== */
async function cashout(){
let amt=parseFloat(prompt("Montant"));
await db.collection("users").doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(-amt)});
saveTransaction(currentUser.gid,"cashout",amt);
notifyUser("Cash-out effectué");
}

/* ===== PAYMENT ===== */
async function pay(){

let amt=parseFloat(prompt("Montant"));
let dest=prompt("ID destinataire");

let snap=await db.collection("users")
.where("gid","==",dest).get();

if(snap.empty){
alert("Utilisateur introuvable");
return;
}

let doc=snap.docs[0];

await db.collection("users").doc(auth.currentUser.uid)
.update({balance:firebase.firestore.FieldValue.increment(-amt)});

await db.collection("users").doc(doc.id)
.update({balance:firebase.firestore.FieldValue.increment(amt)});

saveTransaction(currentUser.gid,"payment",amt);
notifyUser("Paiement envoyé");
}

/* ===== AUTH WATCH ===== */
auth.onAuthStateChanged(user=>{
if(user){
db.collection("users").doc(user.uid)
.get()
.then(s=>loadUser(s.data()));
}
});

/* ===== LOGOUT ===== */
function logout(){
auth.signOut();
document.body.style.background="#061e1c";
location.reload();
}

/* ===== API AGENT SIMULE ===== */
function agentDeposit(agentID,clientID,amount){
notifyUser("Agent "+agentID+" a crédité "+amount);
}

</script>
</body>
</html>
