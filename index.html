<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GoPay Africa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{
  margin:0; font-family:Roboto; background:#061e1c; color:#e6fffa; transition:0.3s;
}
header{
  background:#012b28; padding:12px 20px; display:flex; justify-content:space-between; align-items:center;
}
.logo-text{font-size:22px; font-weight:700; color:#5eead4;}
.menu-btn{font-size:28px; cursor:pointer;}
.menu{
  display:none; position:absolute; top:60px; right:20px; background:#043837; border-radius:12px;
}
.menu a{
  display:block; padding:12px; color:#5eead4; cursor:pointer;
}
.menu a:hover{background:#065f5b;}
.panel{
  background:#043837; padding:20px; border-radius:18px; margin:20px; transition:0.3s;
}
.hidden{display:none;}
.actions{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:20px;
}
.action{
  background:linear-gradient(135deg,#00c6ff,#0072ff); padding:12px; border-radius:14px;
  text-align:center; font-weight:700; cursor:pointer; transition:0.3s; color:white;
}
.action:hover{background:linear-gradient(135deg,#0072ff,#00c6ff);}
.card{
  background:linear-gradient(135deg,#0b3c39,#021f1d); border-radius:18px;
  padding:20px; text-align:center; position:relative; margin-bottom:20px;
}
.card-info h3, .card-info p{margin:5px 0;}
.card-stylized{
  width:300px; height:180px; background:#0a97a0; border-radius:16px;
  padding:20px; color:white; position:relative; margin:20px auto; box-shadow:0 6px 15px rgba(0,0,0,0.3);
}
.card-stylized h4{margin:5px 0;}
.card-stylized p{font-size:14px; margin:3px 0;}
footer{
  margin-top:30px; padding:20px; text-align:center; font-size:14px; opacity:.9;
}
footer h4{color:#5eead4; margin-bottom:6px;}
</style>
</head>

<body>
<header>
  <div class="logo-text">GoPay Africa</div>
  <div class="menu-btn" onclick="toggleMenu()">☰</div>
</header>

<div class="menu" id="menu">
  <a onclick="show('home')">Accueil</a>
  <a onclick="show('login')">Connexion</a>
  <a id="adminBtn" class="hidden" onclick="openAdmin()">Admin Panel</a>
  <a onclick="logout()">Déconnexion</a>
</div>

<!-- HOME -->
<div id="home" class="panel">
  <h2>Banque Digitale Africaine</h2>
  <p>GoPay Africa est une néobanque panafricaine offrant des solutions financières digitales sécurisées.</p>
</div>

<!-- LOGIN -->
<div id="login" class="panel hidden">
  <h3>Connexion</h3>
  <input id="lEmail" placeholder="Email">
  <input id="lPass" type="password" placeholder="Mot de passe">
  <button onclick="login()">Connexion</button>
  <button onclick="show('register')">Créer compte</button>
  <button onclick="show('home')">⬅ Retour</button>
</div>

<!-- REGISTER -->
<div id="register" class="panel hidden">
  <h3>Créer compte</h3>
  <input id="rName" placeholder="Nom">
  <input id="rEmail" placeholder="Email">
  <input id="rPass" type="password" placeholder="Mot de passe">
  <select id="rRole">
    <option value="client">Client</option>
    <option value="agent">Agent</option>
    <option value="admin">Admin</option>
  </select>
  <input type="file" id="rAvatar" accept="image/*">
  <button onclick="register()">Créer</button>
  <button onclick="show('login')">⬅ Retour</button>
</div>

<!-- DASHBOARD -->
<div id="dash" class="panel hidden">

  <div class="card-stylized">
    <h4 id="cardName">Nom</h4>
    <p>ID : <span id="cardId">GP000001</span></p>
    <p>Solde : <b id="balance">0.00</b> <span id="currency">USD</span></p>
    <canvas id="qrCode" style="margin-top:10px;"></canvas>
  </div>

  <div class="actions">
    <div class="action" onclick="cashin()">Cash-in</div>
    <div class="action" onclick="cashout()">Cash-out</div>
    <div class="action" onclick="initPay()">Paiement</div>
    <div class="action" onclick="logout()">Déconnexion</div>
  </div>

  <h4>Activités récentes</h4>
  <div id="history"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="panel hidden">
  <h3>Admin Panel</h3>
  <p>Total Transactions: <span id="totalTransactions">0</span></p>
  <p>Total Clients: <span id="totalClients">0</span></p>
  <p>Total Agents: <span id="totalAgents">0</span></p>
  <table id="usersTable"></table>
  <button onclick="show('dash')">⬅ Retour</button>
</div>

<footer>
  GoPay Africa Digital Finance Ltd © 2026
</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA-p_WgDeRhaGsP0zJYmd9aIw7GwuC6k6g",
  authDomain:"gotrustpay-e6524.firebaseapp.com",
  projectId:"gotrustpay-e6524",
});

const auth=firebase.auth();
const db=firebase.firestore();
let currentUser=null;
let defaultAvatar="https://via.placeholder.com/80";

// ===== UTILS =====
function toggleMenu(){menu.style.display = menu.style.display==="block"?"none":"block";}
function show(id){
  menu.style.display="none";
  document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// ===== REGISTER =====
async function register(){
  try{
    const cred = await auth.createUserWithEmailAndPassword(rEmail.value,rPass.value);
    let avatarURL=defaultAvatar;
    const avatarFile=document.getElementById("rAvatar").files[0];
    if(avatarFile){
      const storageRef=firebase.storage().ref("avatars/"+cred.user.uid);
      await storageRef.put(avatarFile);
      avatarURL=await storageRef.getDownloadURL();
    }
    const gid="GP"+Math.floor(100000+Math.random()*900000);
    await db.collection("users").doc(cred.user.uid).set({
      name:rName.value,email:rEmail.value,gid,balance:50,role:rRole.value,avatar:avatarURL,
      currency:"USD",sessionToken:null,totalCommission:0
    });
    rName.value=""; rEmail.value=""; rPass.value=""; document.getElementById("rAvatar").value="";
    loginAuto();
  }catch(e){alert(e.message);}
}

// ===== LOGIN =====
async function login(){
  try{
    const cred=await auth.signInWithEmailAndPassword(lEmail.value,lPass.value);
    lEmail.value=""; lPass.value="";
    loadUserData(cred.user.uid);
  }catch(e){alert("Connexion refusée");}
}

async function loginAuto(){
  const user=auth.currentUser;
  if(user) loadUserData(user.uid);
}

// ===== LOAD USER =====
async function loadUser(d){
  currentUser=d;
  document.body.style.background="#0a2e2b";
  document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
  document.getElementById("dash").classList.remove("hidden");

  document.getElementById("cardName").innerText=d.name;
  document.getElementById("cardId").innerText=d.gid;
  document.getElementById("balance").innerText=d.balance.toFixed(2);
  document.getElementById("currency").innerText=d.currency;
  generateQRCode(d.gid);
  loadHistory();
}

// ===== QR CODE =====
function generateQRCode(id){
  QRCode.toCanvas(document.getElementById("qrCode"),id,{width:120},e=>{if(e)console.error(e);});
}

// ===== CASHIN / CASHOUT / PAYMENT =====
async function cashin(){
  let amt=parseFloat(prompt("Montant Cash-in"));
  if(!amt) return;
  await db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(amt)});
  alert("Cash-in réussi");
  loadUser(currentUser);
}

async function cashout(){
  let amt=parseFloat(prompt("Montant Cash-out"));
  if(!amt) return;
  let pin=prompt("PIN 4 chiffres");
  let otp=prompt("OTP 6 chiffres");
  if(!verifyDoubleSignature(pin,otp)){alert("Double signature invalide");return;}
  await db.collection("users").doc(auth.currentUser.uid).update({balance:firebase.firestore.FieldValue.increment(-amt)});
  saveTransaction(currentUser.gid,"cashout",amt);
  alert("Cash-out réussi");
  loadUser(currentUser);
}

async function initPay(){
  let amt=parseFloat(prompt("Montant paiement"));
  if(!amt) return;
  let recipientId=prompt("ID destinataire");
  if(!recipientId) return;
  const snap=await db.collection("users").doc(recipientId).get();
  if(!snap.exists){alert("Utilisateur introuvable"); return;}
  const recipient=snap.data();
  let pin=prompt("PIN 4 chiffres");
  let otp=prompt("OTP 6 chiffres");
  if(!verifyDoubleSignature(pin,otp)){alert("Double signature invalide"); return;}
  if(!confirm(`Confirmer paiement de ${amt} à ${recipient.name} (${recipient.gid}) ?`)) return;

  let agentCommission=0;
  let adminCommission=amt*0.01;
  if(currentUser.role==="agent") agentCommission=amt*0.02;

  await db.collection("users").doc(currentUser.gid).update({balance:firebase.firestore.FieldValue.increment(-(amt+agentCommission+adminCommission))});
  await db.collection("users").doc(recipientId).update({balance:firebase.firestore.FieldValue.increment(amt)});
  saveTransaction(currentUser.gid,"pay",amt);
  alert(`Paiement de ${amt} USD effectué vers ${recipient.name}\nCommission Agent: ${agentCommission.toFixed(2)}, Admin: ${adminCommission.toFixed(2)}`);
  loadUser(currentUser);
}

// ===== HISTORIQUE =====
async function loadHistory(){
  const snapshot=await db.collection("transactions").orderBy("date","desc").limit(5).get();
  let html="";
  snapshot.forEach(s=>{
    const t=s.data();
    html+=`<p>${t.date.toDate().toLocaleDateString()} : ${t.type} - ${t.amount} USD</p>`;
  });
  document.getElementById("history").innerHTML=html;
}

// ===== DOUBLE SIGNATURE =====
function verifyDoubleSignature(pin,otp){return pin.length===4 && otp.length===6;}

// ===== TRANSACTION LOG =====
function saveTransaction(userId,type,amount){
  db.collection("transactions").add({userId,type,amount,date:new Date()});
}

// ===== KYC =====
function submitKYC(userId,docURL){db.collection("kyc").doc(userId).set({document:docURL,status:"pending"});}

// ===== LOGOUT =====
function logout(){auth.signOut();show("home");}

// ===== SESSION MULTI-APPAREIL =====
async function loadUserData(uid){
  const snap=await db.collection("users").doc(uid).get();
  if(!snap.exists) return;
  currentUser=snap.data();
  if(currentUser.sessionToken && currentUser.sessionToken!==uid){alert("Session active sur un autre appareil"); logout();}
  else{
    await db.collection("users").doc(uid).update({sessionToken:uid});
    loadUser(currentUser);
  }
}

// ===== API AGENT =====
function agentDeposit(agentID,clientID,amount){notifyUser("Agent "+agentID+" a crédité "+amount);}

// ===== NOTIFICATIONS =====
function notifyUser(msg){alert("Notification GoPay : "+msg);}
</script>

</body>
</html>
